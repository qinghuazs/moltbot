---
summary: "æ·±å…¥ï¼šä¼šè¯å­˜å‚¨ã€è½¬å½•ã€ç”Ÿå‘½å‘¨æœŸä¸è‡ªåŠ¨å‹ç¼©å†…éƒ¨æœºåˆ¶"
read_when:
  - éœ€è¦æ’æŸ¥ session idã€è½¬å½• JSONL æˆ– sessions.json å­—æ®µ
  - ä¿®æ”¹è‡ªåŠ¨å‹ç¼©è¡Œä¸ºæˆ–æ·»åŠ å‹ç¼©å‰æ¸…ç†
  - å®ç°è®°å¿†åˆ·å†™æˆ–é™é»˜ç³»ç»Ÿå›åˆ
---
# ä¼šè¯ç®¡ç†ä¸å‹ç¼©ï¼ˆæ·±å…¥ï¼‰

æœ¬æ–‡è§£é‡Š Moltbot å¦‚ä½•ç«¯åˆ°ç«¯ç®¡ç†ä¼šè¯ï¼š

- **ä¼šè¯è·¯ç”±**ï¼ˆå…¥ç«™æ¶ˆæ¯å¦‚ä½•æ˜ å°„åˆ° `sessionKey`ï¼‰
- **ä¼šè¯å­˜å‚¨**ï¼ˆ`sessions.json`ï¼‰åŠå…¶è·Ÿè¸ªå†…å®¹
- **è½¬å½•æŒä¹…åŒ–**ï¼ˆ`*.jsonl`ï¼‰åŠå…¶ç»“æ„
- **è½¬å½•å«ç”Ÿ**ï¼ˆè¿è¡Œå‰çš„ provider ä¿®å¤ï¼‰
- **ä¸Šä¸‹æ–‡é™åˆ¶**ï¼ˆä¸Šä¸‹æ–‡çª—å£ä¸è·Ÿè¸ª tokenï¼‰
- **å‹ç¼©**ï¼ˆæ‰‹åŠ¨ä¸è‡ªåŠ¨ï¼‰åŠå‹ç¼©å‰æ¸…ç†æŒ‚ç‚¹
- **é™é»˜ç»´æŠ¤**ï¼ˆä¾‹å¦‚ä¸åº”å¯¹ç”¨æˆ·å¯è§çš„è®°å¿†å†™å…¥ï¼‰

å¦‚æœæƒ³å…ˆçœ‹é«˜å±‚æ¦‚è§ˆï¼Œå¯ä»è¿™é‡Œå¼€å§‹ï¼š
- [/concepts/session](/concepts/session)
- [/concepts/compaction](/concepts/compaction)
- [/concepts/session-pruning](/concepts/session-pruning)
- [/reference/transcript-hygiene](/reference/transcript-hygiene)

---

## çœŸå€¼æ¥æºï¼šGateway

Moltbot ä»¥å•ä¸€ **Gateway è¿›ç¨‹**ä¸ºä¸­å¿ƒæ¥ç®¡ç†ä¼šè¯çŠ¶æ€ã€‚

- UIï¼ˆmacOS appã€Web Control UIã€TUIï¼‰åº”ä» Gateway æŸ¥è¯¢ä¼šè¯åˆ—è¡¨ä¸ token è®¡æ•°ã€‚
- åœ¨è¿œç¨‹æ¨¡å¼ä¸‹ï¼Œä¼šè¯æ–‡ä»¶ä½äºè¿œç¨‹ä¸»æœºï¼›æ£€æŸ¥æœ¬åœ° Mac æ–‡ä»¶æ— æ³•åæ˜  Gateway å®é™…ä½¿ç”¨æƒ…å†µã€‚

---

## ä¸¤å±‚æŒä¹…åŒ–

Moltbot é€šè¿‡ä¸¤å±‚æŒä¹…åŒ–ä¼šè¯ï¼š

1) **ä¼šè¯å­˜å‚¨ï¼ˆ`sessions.json`ï¼‰**
   - key/value æ˜ å°„ï¼š`sessionKey -> SessionEntry`
   - å°è€Œå¯å˜ï¼Œå…è®¸ç¼–è¾‘ï¼ˆæˆ–åˆ é™¤æ¡ç›®ï¼‰
   - è·Ÿè¸ªä¼šè¯å…ƒæ•°æ®ï¼ˆå½“å‰ session idã€æœ€åæ´»åŠ¨ã€å¼€å…³ã€token è®¡æ•°ç­‰ï¼‰

2) **è½¬å½•ï¼ˆ`<sessionId>.jsonl`ï¼‰**
   - è¿½åŠ å¼è½¬å½•ï¼Œæ ‘ç»“æ„ï¼ˆæ¡ç›®åŒ…å« `id` + `parentId`ï¼‰
   - å­˜å‚¨çœŸå®å¯¹è¯ã€å·¥å…·è°ƒç”¨ä¸å‹ç¼©æ‘˜è¦
   - ç”¨äºé‡å»ºåç»­è½®æ¬¡çš„æ¨¡å‹ä¸Šä¸‹æ–‡

---

## ç£ç›˜è·¯å¾„

æŒ‰ä»£ç†ï¼Œåœ¨ Gateway ä¸»æœºä¸Šï¼š

- å­˜å‚¨ï¼š`~/.clawdbot/agents/<agentId>/sessions/sessions.json`
- è½¬å½•ï¼š`~/.clawdbot/agents/<agentId>/sessions/<sessionId>.jsonl`
  - Telegram ä¸»é¢˜ä¼šè¯ï¼š`.../<sessionId>-topic-<threadId>.jsonl`

Moltbot é€šè¿‡ `src/config/sessions.ts` è§£æè¿™äº›è·¯å¾„ã€‚

---

## ä¼šè¯ keyï¼ˆ`sessionKey`ï¼‰

`sessionKey` ç”¨äºæ ‡è¯†ä½ æ‰€åœ¨çš„**å¯¹è¯æ¡¶**ï¼ˆè·¯ç”±ä¸éš”ç¦»ï¼‰ã€‚

å¸¸è§æ¨¡å¼ï¼š

- ä¸»ä¼šè¯æˆ–ç§èŠï¼ˆæ¯ä»£ç†ï¼‰ï¼š`agent:<agentId>:<mainKey>`ï¼ˆé»˜è®¤ `main`ï¼‰
- ç¾¤èŠï¼š`agent:<agentId>:<channel>:group:<id>`
- æˆ¿é—´æˆ–é¢‘é“ï¼ˆDiscord/Slackï¼‰ï¼š`agent:<agentId>:<channel>:channel:<id>` æˆ– `...:room:<id>`
- Cronï¼š`cron:<job.id>`
- Webhookï¼š`hook:<uuid>`ï¼ˆé™¤éè¦†ç›–ï¼‰

è§„èŒƒè§„åˆ™è§ [/concepts/session](/concepts/session)ã€‚

---

## ä¼šè¯ idï¼ˆ`sessionId`ï¼‰

æ¯ä¸ª `sessionKey` æŒ‡å‘ä¸€ä¸ªå½“å‰ `sessionId`ï¼ˆè¯¥è½¬å½•æ–‡ä»¶ç»§ç»­å¯¹è¯ï¼‰ã€‚

ç»éªŒæ³•åˆ™ï¼š
- **é‡ç½®**ï¼ˆ`/new`ã€`/reset`ï¼‰ä¸ºè¯¥ `sessionKey` åˆ›å»ºæ–°çš„ `sessionId`ã€‚
- **æ¯æ—¥é‡ç½®**ï¼ˆé»˜è®¤åœ¨ Gateway ä¸»æœºæœ¬åœ°æ—¶é—´ 04:00ï¼‰ä¼šåœ¨è¾¹ç•Œåç¬¬ä¸€æ¡æ¶ˆæ¯åˆ›å»ºæ–°çš„ `sessionId`ã€‚
- **ç©ºé—²è¿‡æœŸ**ï¼ˆ`session.reset.idleMinutes` æˆ–æ—§çš„ `session.idleMinutes`ï¼‰ä¼šåœ¨ç©ºé—²çª—åæ–°æ¶ˆæ¯åˆ°è¾¾æ—¶åˆ›å»ºæ–°çš„ `sessionId`ã€‚å½“æ¯æ—¥ä¸ç©ºé—²åŒæ—¶é…ç½®æ—¶ï¼Œä»¥å…ˆåˆ°æœŸè€…ä¸ºå‡†ã€‚

å®ç°ç»†èŠ‚ï¼šå†³ç­–å‘ç”Ÿåœ¨ `src/auto-reply/reply/session.ts` çš„ `initSessionState()`ã€‚

---

## ä¼šè¯å­˜å‚¨ç»“æ„ï¼ˆ`sessions.json`ï¼‰

å­˜å‚¨å€¼ç±»å‹ä¸º `src/config/sessions.ts` ä¸­çš„ `SessionEntry`ã€‚

å…³é”®å­—æ®µï¼ˆéå®Œæ•´ï¼‰ï¼š

- `sessionId`ï¼šå½“å‰è½¬å½• idï¼ˆæ–‡ä»¶åä»ä¸­æ¨å¯¼ï¼Œé™¤éè®¾ç½® `sessionFile`ï¼‰
- `updatedAt`ï¼šæœ€åæ´»åŠ¨æ—¶é—´æˆ³
- `sessionFile`ï¼šå¯é€‰çš„æ˜¾å¼è½¬å½•è·¯å¾„è¦†ç›–
- `chatType`ï¼š`direct | group | room`ï¼ˆå¸®åŠ© UI ä¸å‘é€ç­–ç•¥ï¼‰
- `provider`ã€`subject`ã€`room`ã€`space`ã€`displayName`ï¼šç¾¤æˆ–é¢‘é“çš„æ ‡ç­¾å…ƒæ•°æ®
- å¼€å…³ï¼š
  - `thinkingLevel`ã€`verboseLevel`ã€`reasoningLevel`ã€`elevatedLevel`
  - `sendPolicy`ï¼ˆæŒ‰ä¼šè¯è¦†ç›–ï¼‰
- æ¨¡å‹é€‰æ‹©ï¼š
  - `providerOverride`ã€`modelOverride`ã€`authProfileOverride`
- Token è®¡æ•°ï¼ˆå°½åŠ›è€Œä¸ºï¼Œä¾èµ– providerï¼‰ï¼š
  - `inputTokens`ã€`outputTokens`ã€`totalTokens`ã€`contextTokens`
- `compactionCount`ï¼šè¯¥ sessionKey è‡ªåŠ¨å‹ç¼©å®Œæˆæ¬¡æ•°
- `memoryFlushAt`ï¼šä¸Šæ¬¡å‹ç¼©å‰è®°å¿†åˆ·å†™æ—¶é—´æˆ³
- `memoryFlushCompactionCount`ï¼šä¸Šæ¬¡åˆ·å†™æ—¶çš„å‹ç¼©è®¡æ•°

å­˜å‚¨å¯ç¼–è¾‘ï¼Œä½† Gateway æ˜¯æƒå¨ï¼šå®ƒå¯èƒ½åœ¨ä¼šè¯è¿è¡Œæ—¶é‡å†™æˆ–é‡å»ºæ¡ç›®ã€‚

---

## è½¬å½•ç»“æ„ï¼ˆ`*.jsonl`ï¼‰

è½¬å½•ç”± `@mariozechner/pi-coding-agent` çš„ `SessionManager` ç®¡ç†ã€‚

æ–‡ä»¶ä¸º JSONLï¼š
- ç¬¬ä¸€è¡Œï¼šä¼šè¯å¤´ï¼ˆ`type: "session"`ï¼ŒåŒ…å« `id`ã€`cwd`ã€`timestamp`ã€å¯é€‰ `parentSession`ï¼‰
- ä¹‹åï¼šåŒ…å« `id` ä¸ `parentId` çš„ä¼šè¯æ¡ç›®ï¼ˆæ ‘ç»“æ„ï¼‰

é‡è¦æ¡ç›®ç±»å‹ï¼š
- `message`ï¼šuser æˆ– assistant æˆ– toolResult
- `custom_message`ï¼šæ‰©å±•æ³¨å…¥ä¸”**è¿›å…¥**æ¨¡å‹ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯ï¼ˆå¯åœ¨ UI ä¸­éšè—ï¼‰
- `custom`ï¼šæ‰©å±•çŠ¶æ€ï¼Œ**ä¸è¿›å…¥**æ¨¡å‹ä¸Šä¸‹æ–‡
- `compaction`ï¼šæŒä¹…åŒ–å‹ç¼©æ‘˜è¦ï¼ŒåŒ…å« `firstKeptEntryId` ä¸ `tokensBefore`
- `branch_summary`ï¼šæ ‘åˆ†æ”¯å¯¼èˆªæ—¶çš„æŒä¹…åŒ–æ‘˜è¦

Moltbot æœ‰æ„**ä¸**ä¿®æ­£è½¬å½•ï¼›Gateway ä½¿ç”¨ `SessionManager` è¯»å†™ã€‚

---

## ä¸Šä¸‹æ–‡çª—å£ä¸è·Ÿè¸ª token

ä¸¤ä¸ªä¸åŒæ¦‚å¿µï¼š

1) **æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£**ï¼šæ¯æ¨¡å‹çš„ç¡¬ä¸Šé™ï¼ˆæ¨¡å‹å¯è§ tokenï¼‰
2) **ä¼šè¯å­˜å‚¨è®¡æ•°**ï¼šå†™å…¥ `sessions.json` çš„æ»šåŠ¨ç»Ÿè®¡ï¼ˆç”¨äº `/status` ä¸ä»ªè¡¨ç›˜ï¼‰

è°ƒå‚æ—¶æ³¨æ„ï¼š
- ä¸Šä¸‹æ–‡çª—å£æ¥è‡ªæ¨¡å‹ç›®å½•ï¼ˆå¯é€šè¿‡é…ç½®è¦†ç›–ï¼‰ã€‚
- å­˜å‚¨ä¸­çš„ `contextTokens` æ˜¯è¿è¡Œæ—¶ä¼°ç®—æˆ–æŠ¥å‘Šå€¼ï¼Œä¸åº”å½“ä½œä¸¥æ ¼ä¿è¯ã€‚

æ›´å¤šè§ [/token-use](/token-use)ã€‚

---

## å‹ç¼©æ˜¯ä»€ä¹ˆ

å‹ç¼©ä¼šå°†è¾ƒæ—§çš„å¯¹è¯æ€»ç»“ä¸ºè½¬å½•ä¸­çš„æŒä¹…åŒ– `compaction` æ¡ç›®ï¼Œå¹¶ä¿ç•™è¿‘æœŸæ¶ˆæ¯ã€‚

å‹ç¼©åï¼Œåç»­è½®æ¬¡ä¼šçœ‹åˆ°ï¼š
- å‹ç¼©æ‘˜è¦
- `firstKeptEntryId` ä¹‹åçš„æ¶ˆæ¯

å‹ç¼©æ˜¯**æŒä¹…åŒ–**çš„ï¼ˆä¸åŒäºä¼šè¯è£å‰ªï¼‰ã€‚è§ [/concepts/session-pruning](/concepts/session-pruning)ã€‚

---

## è‡ªåŠ¨å‹ç¼©è§¦å‘æ—¶æœºï¼ˆPi è¿è¡Œæ—¶ï¼‰

åµŒå…¥å¼ Pi agent ä¸­ï¼Œè‡ªåŠ¨å‹ç¼©åœ¨ä¸¤ç§æƒ…å†µä¸‹è§¦å‘ï¼š

1) **æº¢å‡ºæ¢å¤**ï¼šæ¨¡å‹è¿”å›ä¸Šä¸‹æ–‡æº¢å‡ºé”™è¯¯ -> å‹ç¼© -> é‡è¯•ã€‚
2) **é˜ˆå€¼ç»´æŠ¤**ï¼šæˆåŠŸä¸€è½®åï¼Œå½“æ»¡è¶³ï¼š

`contextTokens > contextWindow - reserveTokens`

å…¶ä¸­ï¼š
- `contextWindow` ä¸ºæ¨¡å‹ä¸Šä¸‹æ–‡çª—å£
- `reserveTokens` ä¸ºæç¤ºä¸ä¸‹ä¸€æ¬¡æ¨¡å‹è¾“å‡ºé¢„ç•™ç©ºé—´

è¿™äº›å±äº Pi è¿è¡Œæ—¶è¯­ä¹‰ï¼ˆMoltbot æ¶ˆè´¹äº‹ä»¶ï¼Œä½†ç”± Pi å†³å®šä½•æ—¶å‹ç¼©ï¼‰ã€‚

---

## å‹ç¼©è®¾ç½®ï¼ˆ`reserveTokens` ä¸ `keepRecentTokens`ï¼‰

Pi çš„å‹ç¼©è®¾ç½®ä½äº Pi settingsï¼š

```json5
{
  compaction: {
    enabled: true,
    reserveTokens: 16384,
    keepRecentTokens: 20000
  }
}
```

Moltbot è¿˜ä¼šä¸ºåµŒå…¥å¼è¿è¡Œè®¾ç½®å®‰å…¨ä¸‹é™ï¼š

- è‹¥ `compaction.reserveTokens < reserveTokensFloor`ï¼ŒMoltbot ä¼šæé«˜å®ƒã€‚
- é»˜è®¤ä¸‹é™ä¸º `20000` tokensã€‚
- è®¾ç½® `agents.defaults.compaction.reserveTokensFloor: 0` å¯ç¦ç”¨ä¸‹é™ã€‚
- å¦‚æœå·²é«˜äºä¸‹é™ï¼ŒMoltbot ä¸ä¼šæ”¹åŠ¨ã€‚

åŸå› ï¼šä¸ºå¤šè½®â€œç»´æŠ¤æ€§ä»»åŠ¡â€ï¼ˆå¦‚è®°å¿†å†™å…¥ï¼‰ä¿ç•™è¶³å¤Ÿç©ºé—´ï¼Œé¿å…å‹ç¼©ä¸å¯é¿å…ã€‚

å®ç°ï¼š`ensurePiCompactionReserveTokens()` åœ¨ `src/agents/pi-settings.ts`
ï¼ˆç”± `src/agents/pi-embedded-runner.ts` è°ƒç”¨ï¼‰ã€‚

---

## ç”¨æˆ·å¯è§é¢

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è§‚å¯Ÿå‹ç¼©ä¸ä¼šè¯çŠ¶æ€ï¼š

- `/status`ï¼ˆä»»æ„èŠå¤©ä¼šè¯ï¼‰
- `moltbot status`ï¼ˆCLIï¼‰
- `moltbot sessions` æˆ– `sessions --json`
- Verbose æ¨¡å¼ï¼š`ğŸ§¹ Auto-compaction complete` + å‹ç¼©è®¡æ•°

---

## é™é»˜ç»´æŠ¤ï¼ˆ`NO_REPLY`ï¼‰

Moltbot æ”¯æŒç”¨äºåå°ä»»åŠ¡çš„â€œé™é»˜â€å›åˆï¼Œç”¨æˆ·ä¸åº”çœ‹åˆ°ä¸­é—´è¾“å‡ºã€‚

çº¦å®šï¼š
- assistant è¾“å‡ºä»¥ `NO_REPLY` å¼€å¤´ï¼Œè¡¨ç¤ºâ€œä¸å‘ç”¨æˆ·æŠ•é€’å›å¤â€ã€‚
- Moltbot åœ¨æŠ•é€’å±‚å‰¥ç¦»æˆ–æŠ‘åˆ¶è¯¥æ ‡è®°ã€‚

è‡ª `2026.1.10` èµ·ï¼Œè‹¥ partial chunk ä»¥ `NO_REPLY` å¼€å¤´ï¼ŒMoltbot ä¹Ÿä¼šæŠ‘åˆ¶**è‰ç¨¿æˆ–è¾“å…¥æŒ‡ç¤ºæµ**ï¼Œé¿å…é™é»˜æ“ä½œåœ¨å›åˆä¸­æ³„éœ²è¾“å‡ºã€‚

---

## å‹ç¼©å‰è®°å¿†åˆ·å†™ï¼ˆå·²å®ç°ï¼‰

ç›®æ ‡ï¼šåœ¨è‡ªåŠ¨å‹ç¼©ä¹‹å‰è¿è¡Œä¸€æ¬¡é™é»˜ä»£ç†å›åˆï¼ŒæŠŠé‡è¦çŠ¶æ€å†™å…¥ç£ç›˜ï¼ˆä¾‹å¦‚å·¥ä½œåŒº `memory/YYYY-MM-DD.md`ï¼‰ï¼Œé¿å…å‹ç¼©ä¸¢å¤±å…³é”®ä¸Šä¸‹æ–‡ã€‚

Moltbot ä½¿ç”¨**é¢„é˜ˆå€¼åˆ·å†™**æ–¹æ¡ˆï¼š

1) ç›‘æ§ä¼šè¯ä¸Šä¸‹æ–‡ç”¨é‡ã€‚
2) å½“è¶…è¿‡â€œè½¯é˜ˆå€¼â€ï¼ˆä½äº Pi å‹ç¼©é˜ˆå€¼ï¼‰æ—¶ï¼Œè¿è¡Œä¸€æ¬¡é™é»˜çš„â€œç«‹å³å†™è®°å¿†â€æŒ‡ä»¤ã€‚
3) ä½¿ç”¨ `NO_REPLY` è®©ç”¨æˆ·æ— æ„ŸçŸ¥ã€‚

é…ç½®ï¼ˆ`agents.defaults.compaction.memoryFlush`ï¼‰ï¼š
- `enabled`ï¼ˆé»˜è®¤ï¼š`true`ï¼‰
- `softThresholdTokens`ï¼ˆé»˜è®¤ï¼š`4000`ï¼‰
- `prompt`ï¼ˆåˆ·å†™å›åˆçš„ç”¨æˆ·æ¶ˆæ¯ï¼‰
- `systemPrompt`ï¼ˆé™„åŠ åˆ°åˆ·å†™å›åˆçš„ç³»ç»Ÿæç¤ºè¯ï¼‰

è¯´æ˜ï¼š
- é»˜è®¤ prompt/system prompt åŒ…å« `NO_REPLY` æç¤ºä»¥æŠ‘åˆ¶æŠ•é€’ã€‚
- æ¯ä¸ªå‹ç¼©å‘¨æœŸä»…è¿è¡Œä¸€æ¬¡ï¼ˆè®°å½•åœ¨ `sessions.json`ï¼‰ã€‚
- ä»…å¯¹åµŒå…¥å¼ Pi ä¼šè¯è¿è¡Œï¼ˆCLI åç«¯è·³è¿‡ï¼‰ã€‚
- å½“ä¼šè¯å·¥ä½œåŒºåªè¯»æ—¶è·³è¿‡ï¼ˆ`workspaceAccess: "ro"` æˆ– `"none"`ï¼‰ã€‚
- å·¥ä½œåŒºæ–‡ä»¶å¸ƒå±€ä¸å†™å…¥æ¨¡å¼è§ [Memory](/concepts/memory)ã€‚

Pi çš„æ‰©å±• API æä¾› `session_before_compact` hookï¼Œä½† Moltbot çš„åˆ·å†™é€»è¾‘ç›®å‰åœ¨ Gateway ä¾§ã€‚

---

## æ•…éšœæ’æŸ¥æ¸…å•

- session key é”™è¯¯ï¼Ÿå…ˆçœ‹ [/concepts/session](/concepts/session)ï¼Œå¹¶åœ¨ `/status` ä¸­ç¡®è®¤ `sessionKey`ã€‚
- å­˜å‚¨ä¸è½¬å½•ä¸åŒ¹é…ï¼Ÿç¡®è®¤ Gateway ä¸»æœºï¼Œä»¥åŠ `moltbot status` æ˜¾ç¤ºçš„å­˜å‚¨è·¯å¾„ã€‚
- å‹ç¼©è¿‡äºé¢‘ç¹ï¼Ÿæ£€æŸ¥ï¼š
  - æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£æ˜¯å¦è¿‡å°
  - å‹ç¼©è®¾ç½®ï¼ˆ`reserveTokens` è¿‡é«˜ä¼šæå‰è§¦å‘ï¼‰
  - å·¥å…·ç»“æœè†¨èƒ€ï¼šå¯ç”¨æˆ–è°ƒæ•´ä¼šè¯è£å‰ª
- é™é»˜å›åˆæ³„éœ²ï¼Ÿç¡®è®¤å›å¤ä»¥ `NO_REPLY`ï¼ˆå®Œå…¨åŒ¹é…ï¼‰å¼€å¤´ï¼Œå¹¶ä¸”æ„å»ºç‰ˆæœ¬åŒ…å«æµå¼æŠ‘åˆ¶ä¿®å¤ã€‚
