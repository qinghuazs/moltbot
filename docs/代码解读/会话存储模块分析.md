# 会话存储模块分析

## 概述

Moltbot 的会话存储系统采用**分层架构**设计，核心模块位于 `src/config/sessions/` 和 `src/sessions/`，负责管理多渠道、多用户的对话状态持久化。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           会话存储架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        应用层                                        │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                │   │
│  │  │  会话初始化  │ │  消息处理    │ │  状态更新    │                │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    会话存储层 (store.ts)                             │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │  内存缓存 (SESSION_STORE_CACHE)                              │  │   │
│  │  │  - TTL: 45秒                                                 │  │   │
│  │  │  - 基于 mtime 的失效检测                                     │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  │                              │                                      │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │  文件锁机制 (withSessionStoreLock)                           │  │   │
│  │  │  - 独占写锁 (.lock文件)                                      │  │   │
│  │  │  - 超时: 10秒                                                │  │   │
│  │  │  - 轮询间隔: 25ms                                            │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    文件系统层                                        │   │
│  │  ~/.clawdbot/sessions.json                                          │   │
│  │  ~/.clawdbot/agents/<agentId>/sessions/*.jsonl                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 模块文件结构

```
src/
├── config/sessions/          # 会话配置和存储核心
│   ├── types.ts             # 会话数据类型定义
│   ├── store.ts             # 存储引擎（带缓存和锁机制）
│   ├── session-key.ts       # 会话键生成和解析
│   ├── metadata.ts          # 会话元数据管理
│   ├── transcript.ts        # 会话转录持久化
│   ├── paths.ts             # 文件路径解析
│   ├── reset.ts             # 会话重置策略
│   ├── group.ts             # 群组会话处理
│   └── main-session.ts      # 主会话键解析
├── sessions/                 # 会话策略和工具
│   ├── session-key-utils.ts # 会话键工具函数
│   ├── send-policy.ts       # 发送策略控制
│   ├── model-overrides.ts   # 模型覆盖管理
│   ├── level-overrides.ts   # 级别覆盖管理
│   └── transcript-events.ts # 转录事件系统
└── routing/
    └── session-key.ts       # 路由层会话键构建
```

## 核心数据结构

### SessionEntry 类型定义

**文件位置**: `src/config/sessions/types.ts:26-97`

```typescript
export type SessionEntry = {
  // 核心标识
  sessionId: string;              // UUID 格式的会话唯一标识
  updatedAt: number;              // 最后更新时间戳（毫秒）
  sessionFile?: string;           // 转录文件路径

  // 会话状态
  systemSent?: boolean;           // 系统消息是否已发送
  abortedLastRun?: boolean;       // 上次运行是否中止

  // 聊天元数据
  chatType?: SessionChatType;     // "direct" | "group" | "channel"
  channel?: string;               // 渠道标识
  groupId?: string;               // 群组ID
  subject?: string;               // 群组主题
  displayName?: string;           // 显示名称

  // 路由信息
  origin?: SessionOrigin;         // 原始来源信息
  deliveryContext?: DeliveryContext; // 投递上下文
  lastChannel?: SessionChannelId; // 最后使用的渠道
  lastTo?: string;                // 最后的接收者
  lastAccountId?: string;         // 最后的账户ID
  lastThreadId?: string | number; // 最后的线程ID

  // 行为配置
  thinkingLevel?: string;         // 思考级别
  verboseLevel?: string;          // 详细级别
  reasoningLevel?: string;        // 推理级别

  // 模型覆盖
  providerOverride?: string;      // 提供商覆盖
  modelOverride?: string;         // 模型覆盖
  authProfileOverride?: string;   // 认证配置覆盖

  // Token统计
  inputTokens?: number;
  outputTokens?: number;
  totalTokens?: number;
  contextTokens?: number;

  // 压缩和内存管理
  compactionCount?: number;       // 压缩次数
  memoryFlushAt?: number;         // 内存刷新时间戳
};
```

## 会话键（Session Key）体系

**文件位置**: `src/routing/session-key.ts`

会话键是会话存储的核心索引机制，采用**分层命名空间**设计：

```
格式模式：
1. 全局会话:     "global"
2. 主会话:       "agent:{agentId}:{mainKey}"
3. 直接消息:     "agent:{agentId}:dm:{peerId}"
4. 群组会话:     "agent:{agentId}:{channel}:group:{groupId}"
5. 频道会话:     "agent:{agentId}:{channel}:channel:{channelId}"
6. 线程会话:     "{baseKey}:thread:{threadId}"
7. 子代理会话:   "agent:{agentId}:subagent:{subagentId}"
```

### 关键函数

| 函数 | 位置 | 功能 |
|------|------|------|
| `buildAgentMainSessionKey()` | 第101-108行 | 构建主会话键 |
| `buildAgentPeerSessionKey()` | 第110-155行 | 构建点对点会话键 |
| `resolveThreadSessionKeys()` | 第201-217行 | 解析线程会话键 |

## 持久化机制

### 双层存储架构

```
应用层
    ↓
会话存储层 (store.ts)
  ├── 内存缓存 (SESSION_STORE_CACHE)
  │   - TTL: 45秒
  │   - 基于 mtime 的失效检测
  │
  └── 文件锁机制 (withSessionStoreLock)
      - 独占写锁 (.lock文件)
      - 超时: 10秒
      - 轮询间隔: 25ms
      - 陈旧锁清理: 30秒
    ↓
文件系统层
  - ~/.clawdbot/sessions.json
  - ~/.clawdbot/agents/<agentId>/sessions/*.jsonl
```

### 缓存策略

```typescript
// 缓存配置
const CACHE_TTL_MS = 45_000;  // 45秒 TTL

// 缓存失效检测
function isCacheValid(cached: CacheEntry): boolean {
  const now = Date.now();
  if (now - cached.loadedAt > CACHE_TTL_MS) return false;

  // 检查文件 mtime
  const stat = fs.statSync(cached.path);
  return stat.mtimeMs <= cached.mtime;
}
```

### 文件锁机制

```typescript
async function withSessionStoreLock<T>(
  fn: () => Promise<T>
): Promise<T> {
  const lockPath = `${sessionsPath}.lock`;
  const timeout = 10_000;
  const pollInterval = 25;
  const staleThreshold = 30_000;

  // 获取锁
  await acquireLock(lockPath, { timeout, pollInterval, staleThreshold });

  try {
    return await fn();
  } finally {
    // 释放锁
    await releaseLock(lockPath);
  }
}
```

## 会话转录持久化

**文件位置**: `src/config/sessions/transcript.ts`

### 转录文件格式

```
~/.clawdbot/agents/<agentId>/sessions/<sessionId>.jsonl

每行一个 JSON 对象：
{"role": "user", "content": "...", "timestamp": 1234567890}
{"role": "assistant", "content": "...", "timestamp": 1234567891}
{"role": "tool", "name": "...", "result": "...", "timestamp": 1234567892}
```

### 转录事件系统

**文件位置**: `src/sessions/transcript-events.ts`

```typescript
type TranscriptEvent = {
  type: "message" | "tool_call" | "tool_result" | "compaction";
  timestamp: number;
  data: unknown;
};

// 事件发射
emitTranscriptEvent(sessionKey, event);

// 事件订阅
subscribeTranscriptEvents(sessionKey, callback);
```

## 会话策略

### 发送策略

**文件位置**: `src/sessions/send-policy.ts`

```typescript
type SendPolicy = "allow" | "deny";

function resolveSendPolicy(session: SessionEntry): SendPolicy {
  // 检查会话级别策略
  if (session.sendPolicy) return session.sendPolicy;

  // 检查通道级别策略
  // 检查全局策略
  // 默认允许
  return "allow";
}
```

### 模型覆盖

**文件位置**: `src/sessions/model-overrides.ts`

```typescript
function resolveModelOverride(session: SessionEntry, cfg: MoltbotConfig) {
  // 优先级：会话覆盖 > Agent 配置 > 全局默认
  return session.modelOverride
    ?? cfg.agents?.[session.agentId]?.model
    ?? cfg.agents?.defaults?.model;
}
```

## 与路由系统的集成

### 路由解析流程

```
入站消息
    ↓
resolveAgentRoute(input)
    ↓
buildAgentPeerSessionKey({
  agentId,
  channel,
  accountId,
  peerKind,
  peerId,
  dmScope,
  identityLinks
})
    ↓
会话键 → 查询/创建 SessionEntry
    ↓
Agent 处理
```

### DM 会话作用域

```typescript
type DmScope =
  | "main"                    // 所有 DM 共享同一会话
  | "per-peer"                // 每个对话方一个会话
  | "per-channel-peer"        // 每个渠道的每个对话方一个会话
  | "per-account-channel-peer"; // 完全隔离
```

## 核心代码位置

```
src/config/sessions/
├── types.ts:26-97           # SessionEntry 类型定义
├── store.ts:50-150          # 存储引擎实现
├── session-key.ts:20-80     # 会话键解析

src/sessions/
├── send-policy.ts:10-50     # 发送策略
├── model-overrides.ts:10-40 # 模型覆盖

src/routing/
├── session-key.ts:101-155   # 会话键构建
```

## 相关文档

- [路由系统](./路由系统/README.md)
- [会话管理系统](./会话管理系统分析.md)
- [配置系统](./配置系统分析.md)
