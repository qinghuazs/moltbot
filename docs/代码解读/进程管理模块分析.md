# 进程管理模块分析

## 概述

Moltbot 的进程管理模块位于 `src/process/` 目录，提供了一套完整的子进程创建、控制、通信和资源管理机制。该模块是整个系统的基础设施层，支撑着 Agent 执行、命令运行、插件系统等核心功能。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           进程管理架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        应用层 (Agents/Commands)                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    命令队列层 (Command Queue)                        │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐               │   │
│  │  │Main Lane │ │Cron Lane │ │ Subagent │ │ Nested   │               │   │
│  │  │ (串行)   │ │ (并发)   │ │  Lane    │ │  Lane    │               │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    进程执行层 (Exec/Spawn)                           │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                │   │
│  │  │   runExec    │ │runCommandWith│ │spawnWithFall │                │   │
│  │  │  (简单执行)  │ │   Timeout    │ │    back      │                │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    信号管理层 (Signal Bridge)                        │   │
│  │  attachChildProcessBridge - 信号转发和清理                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 模块文件结构

```
src/process/
├── exec.ts                      # 命令执行封装 (125行)
├── command-queue.ts             # 命令队列管理 (152行)
├── child-process-bridge.ts      # 子进程信号桥接 (47行)
├── spawn-utils.ts               # 进程创建工具 (127行)
├── lanes.ts                     # 命令通道定义 (6行)
└── *.test.ts                    # 测试文件
```

## 命令通道 (Command Lanes)

**文件位置**: `src/process/lanes.ts`

```typescript
export const enum CommandLane {
  Main = "main",        // 主通道：串行执行
  Cron = "cron",        // 定时任务通道：支持并发
  Subagent = "subagent", // 子代理通道：支持并发
  Nested = "nested",    // 嵌套通道：用于嵌套命令
}
```

**设计理念**:
- 通过通道隔离不同类型的任务
- Main 通道保持串行，确保主流程的 stdin/stdout 不交错
- Cron 和 Subagent 通道支持并发，提高系统吞吐量

## 子进程创建和控制

### 基础执行函数 - runExec

**文件位置**: `src/process/exec.ts:12-38`

```typescript
export async function runExec(
  command: string,
  args: string[],
  opts: number | { timeoutMs?: number; maxBuffer?: number } = 10_000,
): Promise<{ stdout: string; stderr: string }>
```

**特点**:
- 基于 `promisify(execFile)` 的简单封装
- 支持超时控制（默认10秒）
- 自动记录详细日志

### 高级执行函数 - runCommandWithTimeout

**文件位置**: `src/process/exec.ts:56-124`

```typescript
export async function runCommandWithTimeout(
  argv: string[],
  optionsOrTimeout: number | CommandOptions,
): Promise<SpawnResult>
```

**核心特性**:
- 超时机制（SIGKILL 强制终止）
- NPM 资金提示抑制
- 标准输入处理
- 事件处理和清理

### 容错创建 - spawnWithFallback

**文件位置**: `src/process/spawn-utils.ts:91-127`

```typescript
export async function spawnWithFallback(
  params: SpawnWithFallbackParams,
): Promise<SpawnWithFallbackResult>
```

**工作流程**:
1. 尝试使用基础选项创建进程
2. 失败时（如 EBADF）遍历 fallbacks 数组
3. 调用 onFallback 回调通知
4. 返回成功的子进程或抛出异常

## 信号桥接机制

**文件位置**: `src/process/child-process-bridge.ts:14-47`

```typescript
export function attachChildProcessBridge(
  child: ChildProcess,
  { signals = defaultSignals, onSignal }: ChildProcessBridgeOptions = {},
): { detach: () => void }
```

**信号处理流程**:

```
父进程接收信号 (SIGTERM/SIGINT/SIGHUP/SIGQUIT)
                    ↓
触发注册的 listener
  1. 调用 onSignal 回调（可选）
  2. 转发信号给子进程: child.kill(signal)
                    ↓
子进程处理信号并退出
                    ↓
子进程触发 'exit' 或 'error' 事件
  自动调用 detach() 清理监听器
```

**平台差异处理**:
```typescript
const defaultSignals: NodeJS.Signals[] =
  process.platform === "win32"
    ? ["SIGTERM", "SIGINT", "SIGBREAK"]  // Windows
    : ["SIGTERM", "SIGINT", "SIGHUP", "SIGQUIT"];  // Unix
```

## 命令队列系统

**文件位置**: `src/process/command-queue.ts`

### 数据结构

```typescript
type QueueEntry = {
  task: () => Promise<unknown>;
  resolve: (value: unknown) => void;
  reject: (reason?: unknown) => void;
  enqueuedAt: number;           // 入队时间戳
  warnAfterMs: number;          // 等待警告阈值
  onWait?: (waitMs: number, queuedAhead: number) => void;
};

type LaneState = {
  lane: string;
  queue: QueueEntry[];          // 等待队列
  active: number;               // 活跃任务数
  maxConcurrent: number;        // 最大并发数
  draining: boolean;            // 是否正在排空
};
```

### 队列管理流程

```
enqueueCommandInLane(lane, task, opts)
                    ↓
1. 创建 QueueEntry
   - 包装 task
   - 记录入队时间
   - 设置警告阈值
                    ↓
2. 加入通道队列
   state.queue.push(entry)
                    ↓
3. 触发排空 drainLane(lane)
                    ↓
pump() 循环
  while (active < maxConcurrent && queue.length > 0)
    - 取出队首任务
    - 检查等待时间，超过阈值则警告
    - active++
    - 异步执行任务
    - 任务完成后 active--，继续 pump()
```

### 并发控制

```typescript
export function setCommandLaneConcurrency(
  lane: string,
  maxConcurrent: number
) {
  const state = getLaneState(lane);
  state.maxConcurrent = Math.max(1, Math.floor(maxConcurrent));
  drainLane(lane);  // 立即应用新的并发限制
}
```

## 错误处理和恢复

### 超时处理

```typescript
// 硬超时 - SIGKILL
const timer = setTimeout(() => {
  if (typeof child.kill === "function") {
    child.kill("SIGKILL");  // 强制终止，无法捕获
  }
}, timeoutMs);
```

### spawn 失败重试

```typescript
function shouldRetry(err: unknown, codes: string[]): boolean {
  const code = err && typeof err === "object" && "code" in err
    ? String((err as { code?: unknown }).code)
    : "";
  return code.length > 0 && codes.includes(code);
}
```

### 队列错误隔离

- 单个任务失败不影响队列其他任务
- 探测类任务的错误不记录（减少噪音）
- 失败后立即继续处理下一个任务

## 安全考虑

### 命令注入防护

所有执行函数都使用 `argv: string[]` 而非字符串拼接，避免 shell 解析导致的注入风险。

### 资源限制

```typescript
const DEFAULT_MAX_OUTPUT = 200_000;  // 200KB
const DEFAULT_PENDING_MAX_OUTPUT = 200_000;
```

## 核心代码位置

```
src/process/
├── exec.ts:12-38              # runExec 基础执行
├── exec.ts:56-124             # runCommandWithTimeout 高级执行
├── spawn-utils.ts:91-127      # spawnWithFallback 容错创建
├── child-process-bridge.ts:14-47  # 信号桥接
├── command-queue.ts:50-78     # 队列管理
├── lanes.ts:1-6               # 通道定义
```

## 相关文档

- [基础设施模块](./基础设施模块分析.md)
- [Agent 模块](./Agent模块分析.md)
- [定时任务系统](./定时任务系统分析.md)
