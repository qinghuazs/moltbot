# 媒体处理模块分析

## 概述

Moltbot 的媒体处理系统由两个核心模块组成：
- **`src/media/`**: 基础媒体管道（存储、转换、服务）
- **`src/media-understanding/`**: AI 驱动的媒体内容理解

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           媒体处理架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        媒体输入层                                    │   │
│  │  • 本地文件路径 (file://)                                           │   │
│  │  • 远程 URL (HTTP/HTTPS)                                           │   │
│  │  • Buffer 数据流                                                    │   │
│  │  • 消息附件 (MediaPaths/MediaUrls)                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    MIME 检测与验证                                   │   │
│  │  1. 文件扩展名映射 (EXT_BY_MIME)                                   │   │
│  │  2. 魔术字节嗅探 (file-type)                                       │   │
│  │  3. HTTP Content-Type 头                                           │   │
│  │  4. 媒体类型分类:                                                  │   │
│  │     - image/* → MAX: 6MB                                           │   │
│  │     - audio/* → MAX: 16MB                                          │   │
│  │     - video/* → MAX: 16MB                                          │   │
│  │     - document/* → MAX: 100MB                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    存储与缓存层                                      │   │
│  │  • 本地存储: ~/.clawdbot/media/                                    │   │
│  │  • 文件命名: {sanitized-name}---{uuid}.{ext}                       │   │
│  │  • TTL 管理: 默认 2 分钟自动清理                                   │   │
│  │  • 下载限制: 5MB 上限，最大 5 次重定向                             │   │
│  │  • SSRF 防护: resolvePinnedHostname()                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    图像处理管道                                      │   │
│  │  后端选择:                                                          │   │
│  │  • macOS + Bun → sips (系统原生)                                   │   │
│  │  • 其他环境 → sharp (Node.js)                                      │   │
│  │                                                                     │   │
│  │  核心功能:                                                          │   │
│  │  1. EXIF 方向校正                                                  │   │
│  │  2. 图像缩放 (保持宽高比)                                          │   │
│  │  3. 格式转换 (HEIC → JPEG)                                         │   │
│  │  4. 优化压缩                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    媒体服务层                                        │   │
│  │  HTTP 服务器 (Express):                                             │   │
│  │  • 端点: GET /media/:id                                            │   │
│  │  • 端口: 42873 (默认)                                              │   │
│  │  • 安全验证: 路径遍历防护                                          │   │
│  │  • TTL 过期检查                                                     │   │
│  │  • Tailscale Funnel 集成                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 模块文件结构

```
src/media/
├── constants.ts              # 常量定义（MIME 类型、大小限制）
├── mime.ts                   # MIME 类型检测
├── store.ts                  # 媒体存储管理
├── fetch.ts                  # 远程媒体下载
├── image-ops.ts              # 图像处理操作
├── server.ts                 # HTTP 媒体服务器
├── host.ts                   # 媒体托管
└── *.test.ts                 # 测试文件

src/media-understanding/
├── types.ts                  # 类型定义
├── apply.ts                  # 媒体理解入口
├── runner.ts                 # 能力执行器
├── config.ts                 # 配置解析
├── providers/                # AI 提供商
│   ├── index.ts              # 提供商注册表
│   ├── openai.ts             # OpenAI 实现
│   ├── anthropic.ts          # Anthropic 实现
│   ├── google.ts             # Google 实现
│   ├── groq.ts               # Groq 实现
│   └── deepgram.ts           # Deepgram 实现
└── cli/                      # 本地 CLI 工具
    ├── detect.ts             # 工具检测
    └── whisper.ts            # Whisper 集成
```

## 媒体内容理解系统

### AI 模型集成架构

```
媒体理解入口 (apply.ts)
        ↓
applyMediaUnderstanding(ctx, cfg, agentDir, providers)
  1. 提取附件 (normalizeAttachments)
  2. 创建缓存 (MediaAttachmentCache)
  3. 并发执行能力 (runWithConcurrency)
  4. 格式化输出 (formatMediaUnderstandingBody)
        ↓
能力路由器 (runner.ts: runCapability)
  执行顺序: ["image", "audio", "video"]
  决策流程:
  1. 检查启用状态
  2. 附件选择策略
  3. 作用域验证
  4. 视觉模型跳过逻辑
  5. 模型选择瀑布
        ↓
提供商注册表 (providers/index.ts)
  • OpenAI    → audio, image
  • Anthropic → image
  • Google    → audio, video, image
  • Groq      → audio
  • Deepgram  → audio
```

### 支持的提供商

| 提供商 | 音频 | 图像 | 视频 |
|--------|------|------|------|
| OpenAI | ✅ | ✅ | ❌ |
| Anthropic | ❌ | ✅ | ❌ |
| Google | ✅ | ✅ | ✅ |
| Groq | ✅ | ❌ | ❌ |
| Deepgram | ✅ | ❌ | ❌ |
| MiniMax | ❌ | ✅ | ❌ |

### 自动选择优先级

```typescript
// 音频转录
Audio: [openai, groq, deepgram, google]

// 图像描述
Image: [openai, anthropic, google, minimax]

// 视频描述
Video: [google]
```

## 核心类型定义

```typescript
// 媒体理解能力
type MediaUnderstandingCapability = "image" | "audio" | "video";

// 媒体理解输出
type MediaUnderstandingOutput = {
  kind: "audio.transcription" | "video.description" | "image.description";
  attachmentIndex: number;
  text: string;
  provider: string;
  model?: string;
};

// 音频转录请求
type AudioTranscriptionRequest = {
  buffer: Buffer;
  fileName: string;
  mime?: string;
  apiKey: string;
  baseUrl?: string;
};

// 图像描述请求
type ImageDescriptionRequest = {
  buffer: Buffer;
  fileName: string;
  mime?: string;
  apiKey: string;
  prompt?: string;
  maxTokens?: number;
};
```

## 本地 CLI 工具自动检测

### 音频转录工具链（优先级顺序）

1. **sherpa-onnx-offline**
   - 环境变量: `SHERPA_ONNX_MODEL_DIR`
   - 需要文件: `tokens.txt`, `encoder.onnx`, `decoder.onnx`, `joiner.onnx`

2. **whisper-cli (whisper.cpp)**
   - 环境变量: `WHISPER_CPP_MODEL`
   - 默认模型: `/opt/homebrew/share/whisper-cpp/for-tests-ggml-tiny.bin`

3. **whisper (OpenAI Whisper Python)**
   - 模型: `turbo`
   - 参数: `--output_format txt --output_dir {dir}`

4. **gemini CLI**
   - 探测: `gemini --output-format json ok`

## 图像处理管道

### 后端选择

```typescript
// macOS + Bun → sips (系统原生)
// 其他环境 → sharp (Node.js)
```

### 核心功能

1. **EXIF 方向校正**
   - 支持 8 种 EXIF 方向值
   - 自动旋转/翻转像素数据

2. **图像缩放**
   - 保持宽高比
   - `withoutEnlargement` 防止放大

3. **格式转换**
   - HEIC → JPEG
   - PNG 透明度保留

4. **优化压缩**
   - 多级尺寸: [2048, 1536, 1280, 1024, 800]
   - 压缩等级: [6, 7, 8, 9]
   - 网格搜索最优参数

## 媒体服务器

### HTTP 端点

```
GET /media/:id
```

### 安全特性

- 路径遍历防护 (`openFileWithinRoot`)
- ID 格式验证 (`[\p{L}\p{N}._-]+`)
- 文件大小限制 (5MB)
- TTL 过期检查
- 单次使用清理

### Tailscale 集成

```
https://{hostname}/media/{id}
```

## 核心代码位置

```
src/media/
├── constants.ts:10-50         # 媒体类型常量
├── mime.ts:20-80              # MIME 检测
├── store.ts:30-120            # 存储管理
├── fetch.ts:40-150            # 远程下载
├── image-ops.ts:50-200        # 图像处理
├── server.ts:30-150           # HTTP 服务器

src/media-understanding/
├── apply.ts:20-100            # 媒体理解入口
├── runner.ts:50-200           # 能力执行器
├── providers/index.ts:10-80   # 提供商注册表
```

## 相关文档

- [AI 提供商模块](./AI提供商模块分析.md)
- [浏览器自动化模块](./浏览器自动化模块分析.md)
- [工具系统](./工具系统/README.md)
