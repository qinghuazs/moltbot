# Moltbot 项目架构概览

## 1. CLI 入口点结构

### 启动流程

```
moltbot.mjs (bin 入口)
  ↓
dist/entry.js (编译后的 src/entry.ts)
  ↓
src/cli/run-main.ts (runCli 函数)
  ↓
src/cli/program/build-program.ts (buildProgram 函数)
  ↓
Commander.js 程序实例
```

### 关键文件

| 文件 | 说明 |
|------|------|
| `moltbot.mjs` | 可执行入口，启用编译缓存 |
| `src/entry.ts` | 进程初始化、环境规范化、警告过滤 |
| `src/cli/run-main.ts` | CLI 运行时主逻辑 |
| `src/cli/program/build-program.ts` | 构建 Commander 程序 |
| `src/index.ts` | 公共 API 导出 |

## 2. src/cli 目录主要文件

### 核心 CLI 模块

- `program.ts` / `program/` - Commander 程序构建和命令注册
- `argv.ts` - 命令行参数解析
- `deps.ts` - 依赖注入工厂
- `prompt.ts` / `progress.ts` - 用户交互（提示、进度条）
- `route.ts` - CLI 路由逻辑

### 子 CLI 系统（按功能分组）

| 文件 | 功能 |
|------|------|
| `gateway-cli.ts` | 网关控制 |
| `daemon-cli.ts` | 守护进程管理 |
| `channels-cli.ts` | 消息通道管理 |
| `browser-cli.ts` | 浏览器自动化 |
| `config-cli.ts` | 配置管理 |
| `memory-cli.ts` | 记忆系统 |
| `models-cli.ts` | 模型配置 |
| `nodes-cli.ts` | 节点系统（canvas、camera、screen） |
| `plugins-cli.ts` | 插件管理 |
| `skills-cli.ts` | 技能管理 |
| `pairing-cli.ts` | 设备配对 |
| `webhooks-cli.ts` | Webhook 管理 |
| `cron-cli.ts` | 定时任务 |
| `tui-cli.ts` | 终端 UI |

## 3. src/commands 目录结构

### Agent 相关

- `agent.ts` - 主 agent 命令
- `agent-via-gateway.ts` - 通过网关运行 agent
- `agents.ts` - agent 管理（列表、添加、删除）
- `agents.commands.*.ts` - agent 子命令
- `agents.config.ts` / `agents.providers.ts` - agent 配置和提供商

### 配置和设置

- `configure.ts` / `configure.*.ts` - 配置向导
- `auth-choice.*.ts` - 认证选择和应用
- `channels.ts` - 通道管理

### 维护和诊断

- `doctor.ts` / `doctor-*.ts` - 系统诊断（约 20 个子模块）
- `health.ts` - 健康检查
- `status.ts` - 状态报告
- `gateway-status.ts` - 网关状态

### 其他核心命令

- `dashboard.ts` - 仪表板
- `sessions.ts` - 会话管理
- `daemon-*.ts` - 守护进程相关
- `cleanup-utils.ts` - 清理工具

## 4. package.json 配置

### Bin 配置

```json
{
  "bin": {
    "moltbot": "./moltbot.mjs",
    "clawdbot": "./moltbot.mjs"  // 兼容性别名
  },
  "main": "dist/index.js"
}
```

### 导出配置

```json
{
  "exports": {
    ".": "./dist/index.js",
    "./plugin-sdk": "./dist/plugin-sdk/index.js",
    "./cli-entry": "./moltbot.mjs"
  }
}
```

## 5. 主要模块目录

### 核心功能模块

| 目录 | 说明 | 文件数 |
|------|------|--------|
| `agents/` | AI agent 核心逻辑 | 294 |
| `gateway/` | 网关服务器 | 127 |
| `commands/` | CLI 命令实现 | 176 |
| `cli/` | CLI 框架 | 106 |
| `config/` | 配置管理 | 122 |
| `infra/` | 基础设施 | 151 |

### 消息通道

| 目录 | 说明 |
|------|------|
| `channels/` | 通道抽象层 |
| `whatsapp/` | WhatsApp 集成 |
| `telegram/` | Telegram 集成 |
| `discord/` | Discord 集成 |
| `slack/` | Slack 集成 |
| `signal/` | Signal 集成 |
| `imessage/` | iMessage 集成 |
| `line/` | LINE 集成 |
| `web/` | Web 通道 |

### AI 和自动化

| 目录 | 说明 |
|------|------|
| `auto-reply/` | 自动回复逻辑 |
| `providers/` | AI 模型提供商 |
| `browser/` | 浏览器自动化 |
| `media/` | 媒体处理 |
| `media-understanding/` | 媒体理解 |
| `link-understanding/` | 链接理解 |
| `memory/` | 记忆系统 |

### 系统和工具

| 目录 | 说明 |
|------|------|
| `daemon/` | 守护进程 |
| `routing/` | 消息路由 |
| `sessions/` | 会话管理 |
| `security/` | 安全功能 |
| `hooks/` | 钩子系统 |
| `cron/` | 定时任务 |
| `pairing/` | 设备配对 |
| `plugins/` | 插件系统 |
| `plugin-sdk/` | 插件 SDK |

### UI 和交互

| 目录 | 说明 |
|------|------|
| `canvas-host/` | Canvas 渲染 |
| `node-host/` | 节点托管 |
| `tui/` | 终端 UI |
| `terminal/` | 终端工具 |
| `macos/` | macOS 特定功能 |

## 6. 模块关系图

```
┌─────────────────────────────────────────────────────────────┐
│                      CLI 入口层                              │
│  moltbot.mjs → entry.ts → run-main.ts → program.ts         │
└────────────────────────┬────────────────────────────────────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
┌────────▼─────────┐          ┌─────────▼──────────┐
│   命令注册层      │          │   命令实现层        │
│  command-registry│          │   src/commands/    │
│  register.*.ts   │          │   (167个命令文件)   │
└────────┬─────────┘          └─────────┬──────────┘
         │                               │
         └───────────────┬───────────────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
┌────────▼─────────┐          ┌─────────▼──────────┐
│   核心服务层      │          │   通道层            │
│  - gateway/      │◄────────►│  - channels/       │
│  - agents/       │          │  - whatsapp/       │
│  - config/       │          │  - telegram/       │
│  - daemon/       │          │  - discord/等      │
└────────┬─────────┘          └─────────┬──────────┘
         │                               │
         └───────────────┬───────────────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
┌────────▼─────────┐          ┌─────────▼──────────┐
│   AI 处理层       │          │   基础设施层        │
│  - auto-reply/   │          │  - infra/          │
│  - providers/    │          │  - logging/        │
│  - memory/       │          │  - security/       │
│  - browser/      │          │  - process/        │
└──────────────────┘          └────────────────────┘
```

## 7. 关键设计模式

1. **依赖注入** - 通过 `createDefaultDeps()` 创建默认依赖
2. **命令模式** - 每个命令都是独立的函数，通过 Commander.js 注册
3. **懒加载** - 子命令按需加载（`register.subclis.ts`）
4. **插件系统** - 支持扩展通道和功能
5. **配置驱动** - 通过 `loadConfig()` 加载 YAML 配置
6. **事件驱动** - 网关使用事件系统处理消息

## 8. 主要命令分类

### 设置和配置

- `moltbot onboard` - 引导向导
- `moltbot setup` - 初始设置
- `moltbot configure` - 配置管理
- `moltbot config` - 配置 CLI

### 网关和服务

- `moltbot gateway` - 启动网关
- `moltbot daemon` - 守护进程管理
- `moltbot status` - 状态检查
- `moltbot health` - 健康检查

### Agent 交互

- `moltbot agent` - 运行 agent
- `moltbot agents` - agent 管理
- `moltbot message` - 发送消息

### 通道管理

- `moltbot channels` - 通道管理
- `moltbot pairing` - 设备配对

### 维护和诊断

- `moltbot doctor` - 系统诊断
- `moltbot update` - 更新 CLI
- `moltbot logs` - 查看日志

## 9. 建议的阅读顺序

1. **CLI 入口** - `src/cli/run-main.ts` 和 `src/cli/program/build-program.ts`
2. **核心命令** - `src/commands/agent.ts`、`src/commands/configure.ts`
3. **核心服务层** - `src/gateway/`、`src/agents/`、`src/config/`
4. **消息通道** - `src/channels/` 抽象层及具体实现
5. **AI 处理** - `src/auto-reply/`、`src/providers/`、`src/memory/`
