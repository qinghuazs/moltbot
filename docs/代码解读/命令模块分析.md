# 命令模块分析

## 概述

Moltbot 的命令系统采用**分层架构**和**插件化设计**，基于 Commander.js 实现，包含 223 个 TypeScript 文件，按功能模块组织。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           命令系统架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        CLI 入口层                                    │   │
│  │                   src/cli/run-main.ts                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    命令注册层 (Commander.js)                         │   │
│  │              src/cli/program/command-registry.ts                    │   │
│  │  - registerProgramCommands()                                        │   │
│  │  - 主命令注册 (setup, onboard, configure, etc.)                    │   │
│  │  - 子命令延迟加载 (lazy loading)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    命令实现层                                        │   │
│  │                   src/commands/                                      │   │
│  │  - 223 个 TypeScript 文件                                           │   │
│  │  - 按功能模块组织 (agent/, channels/, models/, etc.)               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    依赖注入层                                        │   │
│  │                   src/cli/deps.ts                                   │   │
│  │  - 消息发送依赖 (WhatsApp, Telegram, Discord, etc.)                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心设计模式

### 命令模式 (Command Pattern)

每个命令都是一个独立的函数，遵循统一的签名：

```typescript
export async function xxxCommand(
  opts: XxxOptions,
  runtime: RuntimeEnv = defaultRuntime,
  deps?: CliDeps
): Promise<void>
```

### 依赖注入 (Dependency Injection)

```typescript
// src/cli/deps.ts:18-27
export function createDefaultDeps(): CliDeps {
  return {
    sendMessageWhatsApp,
    sendMessageTelegram,
    sendMessageDiscord,
    sendMessageSlack,
    sendMessageSignal,
    sendMessageIMessage,
  };
}
```

### 延迟加载 (Lazy Loading)

子命令采用延迟加载策略，提升启动性能：

```typescript
// src/cli/program/register.subclis.ts:249-270
function registerLazyCommand(program: Command, entry: SubCliEntry) {
  const placeholder = program.command(entry.name).description(entry.description);
  placeholder.allowUnknownOption(true);
  placeholder.allowExcessArguments(true);
  placeholder.action(async (...actionArgs) => {
    removeCommand(program, placeholder);
    await entry.register(program);
    // 重新解析参数
  });
}
```

## 命令分类树

```
moltbot
├── 初始化命令
│   ├── setup          # 首次安装配置
│   ├── onboard        # 交互式引导
│   └── configure      # 配置向导
│
├── Agent 命令
│   ├── agent          # 执行 Agent 对话
│   └── agents         # Agent 管理
│       ├── list       # 列出所有 Agent
│       ├── add        # 添加新 Agent
│       ├── delete     # 删除 Agent
│       └── set-identity # 设置 Agent 身份
│
├── 消息命令
│   └── message        # 消息操作
│       ├── send       # 发送消息
│       ├── broadcast  # 广播消息
│       ├── poll       # 创建投票
│       ├── react      # 添加反应
│       ├── read       # 读取消息
│       ├── edit       # 编辑消息
│       ├── delete     # 删除消息
│       ├── pin        # 固定消息
│       └── thread     # 线程操作
│
├── 通道命令
│   └── channels       # 通道管理
│       ├── add        # 添加通道
│       ├── remove     # 移除通道
│       ├── list       # 列出通道
│       ├── status     # 通道状态
│       └── capabilities # 通道能力
│
├── 模型命令
│   └── models         # 模型管理
│       ├── list       # 列出模型
│       ├── status     # 模型状态
│       ├── auth       # 认证管理
│       └── aliases    # 模型别名
│
├── 网关命令
│   └── gateway        # 网关控制
│       ├── run        # 运行网关
│       ├── probe      # 探测网关
│       └── status     # 网关状态
│
├── 系统命令
│   ├── status         # 系统状态
│   ├── health         # 健康检查
│   ├── sessions       # 会话管理
│   ├── doctor         # 诊断修复
│   ├── logs           # 日志查看
│   └── update         # 更新管理
│
└── 其他命令
    ├── config         # 配置管理
    ├── plugins        # 插件管理
    ├── security       # 安全审计
    └── reset          # 重置系统
```

## 核心命令详解

### Agent 命令

**文件位置**: `src/commands/agent.ts:63-521`

```typescript
export async function agentCommand(
  opts: AgentCommandOpts,
  runtime: RuntimeEnv = defaultRuntime,
  deps: CliDeps = createDefaultDeps(),
) {
  // 1. 参数验证
  const body = (opts.message ?? "").trim();
  if (!body) throw new Error("Message (--message) is required");

  // 2. 加载配置和解析 Agent
  const cfg = loadConfig();

  // 3. 解析会话
  const sessionResolution = resolveSession({...});

  // 4. 构建技能快照
  const skillsSnapshot = buildWorkspaceSkillSnapshot(...);

  // 5. 执行 Agent (支持模型降级)
  const fallbackResult = await runWithModelFallback({...});

  // 6. 更新会话存储
  await updateSessionStoreAfterAgentRun({...});

  // 7. 交付结果
  return await deliverAgentCommandResult({...});
}
```

### Status 命令

**文件位置**: `src/commands/status.command.ts:42-579`

**状态扫描项**:
- OS 信息
- Tailscale 状态
- 更新可用性
- 网关连接
- 通道状态
- Agent 状态
- 内存系统
- 安全审计

### Doctor 命令

**文件位置**: `src/commands/doctor.ts:65-306`

**诊断项目**:
1. 配置文件迁移
2. 认证配置健康检查
3. 网关认证令牌生成
4. 遗留状态迁移
5. 沙箱镜像修复
6. 网关服务配置
7. 安全警告

## 命令参数解析

### 参数定义模式

```typescript
// src/cli/program/register.agent.ts:22-47
program
  .command("agent")
  .description("Run an agent turn via the Gateway")
  .requiredOption("-m, --message <text>", "Message body")
  .option("-t, --to <number>", "Recipient number in E.164")
  .option("--session-id <id>", "Use an explicit session id")
  .option("--agent <id>", "Agent id override")
  .option("--thinking <level>", "Thinking level")
  .option("--json", "Output result as JSON", false)
  .action(async (opts) => {
    await agentCliCommand(opts, defaultRuntime, deps);
  });
```

### 参数验证策略

```typescript
// 必填参数验证
const body = (opts.message ?? "").trim();
if (!body) throw new Error("Message (--message) is required");

// 枚举值验证
const thinkOverride = normalizeThinkLevel(opts.thinking);
if (opts.thinking && !thinkOverride) {
  throw new Error(`Invalid thinking level.`);
}

// 数值范围验证
const timeoutSecondsRaw = Number.parseInt(String(opts.timeout), 10);
if (Number.isNaN(timeoutSecondsRaw) || timeoutSecondsRaw <= 0) {
  throw new Error("--timeout must be a positive integer");
}
```

## 命令类型定义

**文件位置**: `src/commands/agent/types.ts:29-77`

```typescript
export type AgentCommandOpts = {
  message: string;
  images?: ImageContent[];
  agentId?: string;
  to?: string;
  sessionId?: string;
  sessionKey?: string;
  thinking?: string;
  verbose?: string;
  json?: boolean;
  timeout?: string;
  deliver?: boolean;
  channel?: string;
  accountId?: string;
  abortSignal?: AbortSignal;
  // ... 更多选项
};
```

## 路由优化机制

支持快速路由，跳过完整的 Commander 解析：

```typescript
// src/cli/program/command-registry.ts:40-50
const routeHealth: RouteSpec = {
  match: (path) => path[0] === "health",
  loadPlugins: true,
  run: async (argv) => {
    const json = hasFlag(argv, "--json");
    await healthCommand({ json, timeoutMs, verbose }, defaultRuntime);
    return true;
  },
};
```

## 核心代码位置

```
src/cli/
├── run-main.ts:26             # CLI 入口
├── program/
│   ├── build-program.ts:7     # 程序构建
│   ├── command-registry.ts:106-155  # 命令注册表
│   └── register.subclis.ts:249-270  # 延迟加载

src/commands/
├── agent.ts:63-521            # Agent 命令
├── status.command.ts:42-579   # Status 命令
├── doctor.ts:65-306           # Doctor 命令
├── channels/add.ts:73-267     # 通道添加
└── agent/types.ts:29-77       # 类型定义
```

## 相关文档

- [CLI 入口层分析](./CLI入口层分析.md)
- [Agent 模块分析](./Agent模块分析.md)
- [配置系统分析](./配置系统分析.md)
