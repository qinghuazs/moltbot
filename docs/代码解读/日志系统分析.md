# 日志系统分析

## 概述

Moltbot 的日志系统位于 `src/logging/` 目录，是一个功能完善的分层日志架构，基于 `tslog` 库构建，提供了文件日志、控制台输出、敏感信息脱敏、子系统分类等核心功能。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           日志系统架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        应用层（业务代码）                            │   │
│  │  createSubsystemLogger("gateway/channels/telegram")                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    子系统日志器层 (subsystem.ts)                     │   │
│  │  - 格式化控制台输出（颜色、前缀）                                    │   │
│  │  - 过滤子系统                                                        │   │
│  │  - 分发到文件日志器和控制台                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│          ┌─────────────────────────┴─────────────────────────┐             │
│          │                                                   │             │
│          ▼                                                   ▼             │
│  ┌──────────────────┐                             ┌──────────────────┐     │
│  │   文件日志器      │                             │   控制台输出      │     │
│  │   (logger.ts)    │                             │   (console.ts)   │     │
│  │  - 滚动日志       │                             │  - 样式控制       │     │
│  │  - JSON 格式      │                             │  - stderr 路由    │     │
│  │  - 自动清理       │                             │  - 时间戳前缀     │     │
│  └──────────────────┘                             └──────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 模块文件结构

```
src/logging/
├── logger.ts              # 核心日志器，文件日志管理
├── subsystem.ts           # 子系统日志器，控制台输出格式化
├── levels.ts              # 日志级别定义与转换
├── state.ts               # 全局日志状态管理
├── config.ts              # 配置读取
├── console.ts             # 控制台捕获与路由
├── redact.ts              # 敏感信息脱敏
├── diagnostic.ts          # 诊断日志（会话、webhook、队列）
├── parse-log-line.ts      # 日志行解析
└── *.test.ts              # 单元测试
```

## 日志级别系统

### 级别定义

**文件位置**: `src/logging/levels.ts`

```typescript
export const ALLOWED_LOG_LEVELS = [
  "silent",   // 完全静默
  "fatal",    // 致命错误
  "error",    // 错误
  "warn",     // 警告
  "info",     // 信息（默认）
  "debug",    // 调试
  "trace",    // 跟踪
] as const;
```

### 级别映射

```typescript
function levelToMinLevel(level: LogLevel): number {
  const map: Record<LogLevel, number> = {
    fatal: 0,
    error: 1,
    warn: 2,
    info: 3,
    debug: 4,
    trace: 5,
    silent: Number.POSITIVE_INFINITY,  // 禁用所有日志
  };
  return map[level];
}
```

## 核心日志器

### 日志文件管理

**文件位置**: `src/logging/logger.ts`

```typescript
// 默认路径
export const DEFAULT_LOG_DIR = "/tmp/moltbot";
export const DEFAULT_LOG_FILE = path.join(DEFAULT_LOG_DIR, "moltbot.log");

// 滚动日志命名格式：moltbot-YYYY-MM-DD.log
function defaultRollingPathForToday(): string {
  const today = formatLocalDate(new Date());
  return path.join(DEFAULT_LOG_DIR, `${LOG_PREFIX}-${today}${LOG_SUFFIX}`);
}

// 自动清理 24 小时前的日志
const MAX_LOG_AGE_MS = 24 * 60 * 60 * 1000; // 24h
```

### 日志器构建

```typescript
function buildLogger(settings: ResolvedSettings): TsLogger<LogObj> {
  // 1. 创建日志目录
  fs.mkdirSync(path.dirname(settings.file), { recursive: true });

  // 2. 清理旧日志
  if (isRollingPath(settings.file)) {
    pruneOldRollingLogs(path.dirname(settings.file));
  }

  // 3. 创建 tslog 实例
  const logger = new TsLogger<LogObj>({
    name: "moltbot",
    minLevel: levelToMinLevel(settings.level),
    type: "hidden", // 禁用 ANSI 格式化
  });

  // 4. 附加文件传输器
  logger.attachTransport((logObj: LogObj) => {
    const time = logObj.date?.toISOString?.() ?? new Date().toISOString();
    const line = JSON.stringify({ ...logObj, time });
    fs.appendFileSync(settings.file, `${line}\n`, { encoding: "utf8" });
  });

  return logger;
}
```

## 子系统日志器

### 接口定义

**文件位置**: `src/logging/subsystem.ts`

```typescript
export type SubsystemLogger = {
  subsystem: string;
  trace: (message: string, meta?: Record<string, unknown>) => void;
  debug: (message: string, meta?: Record<string, unknown>) => void;
  info: (message: string, meta?: Record<string, unknown>) => void;
  warn: (message: string, meta?: Record<string, unknown>) => void;
  error: (message: string, meta?: Record<string, unknown>) => void;
  fatal: (message: string, meta?: Record<string, unknown>) => void;
  raw: (message: string) => void;  // 原始输出，不格式化
  child: (name: string) => SubsystemLogger;  // 创建子日志器
};
```

### 子系统命名与层次结构

```typescript
// 示例：创建分层子系统
const gatewayLog = createSubsystemLogger("gateway");
const channelsLog = gatewayLog.child("channels");
const telegramLog = channelsLog.child("telegram");
// 最终子系统名：gateway/channels/telegram
```

### 控制台输出格式化

**三种样式**:

1. **pretty**（默认 TTY）：
   ```
   12:34:56 [telegram] Message received from user
   ```

2. **compact**（非 TTY）：
   ```
   2026-01-30T12:34:56.789Z [telegram] Message received from user
   ```

3. **json**：
   ```json
   {"time":"2026-01-30T12:34:56.789Z","level":"info","subsystem":"telegram","message":"Message received"}
   ```

## 敏感信息脱敏

### 脱敏模式

**文件位置**: `src/logging/redact.ts`

```typescript
export type RedactSensitiveMode = "off" | "tools";

// 配置
export type LoggingConfig = {
  redactSensitive?: "off" | "tools";  // 默认: "tools"
  redactPatterns?: string[];          // 自定义正则模式
};
```

### 默认脱敏模式

```typescript
const DEFAULT_REDACT_PATTERNS: string[] = [
  // 环境变量赋值
  String.raw`\b[A-Z0-9_]*(?:KEY|TOKEN|SECRET|PASSWORD)\b\s*[=:]\s*(["']?)([^\s"'\\]+)\1`,

  // JSON 字段
  String.raw`"(?:apiKey|token|secret|password)"\s*:\s*"([^"]+)"`,

  // Authorization 头
  String.raw`Authorization\s*[:=]\s*Bearer\s+([A-Za-z0-9._\-+=]+)`,

  // 常见 Token 前缀
  String.raw`\b(sk-[A-Za-z0-9_-]{8,})\b`,              // OpenAI
  String.raw`\b(ghp_[A-Za-z0-9]{20,})\b`,              // GitHub
  String.raw`\b(xox[baprs]-[A-Za-z0-9-]{10,})\b`,      // Slack
];
```

### 脱敏示例

| 原始值 | 脱敏后 |
|--------|--------|
| `OPENAI_API_KEY=sk-1234567890abcdef` | `OPENAI_API_KEY=sk-123…cdef` |
| `Authorization: Bearer abcdef1234567890ghij` | `Authorization: Bearer abcdef…ghij` |
| `TOKEN=short` | `TOKEN=***` |

## 诊断日志系统

### 诊断事件类型

**文件位置**: `src/logging/diagnostic.ts`

```typescript
// 诊断事件
- webhook.received      // Webhook 接收
- webhook.processed     // Webhook 处理完成
- webhook.error         // Webhook 错误
- message.queued        // 消息入队
- message.processed     // 消息处理完成
- session.state         // 会话状态变更
- session.stuck         // 会话卡住
- queue.lane.enqueue    // 队列入队
- queue.lane.dequeue    // 队列出队
- diagnostic.heartbeat  // 心跳
```

### 会话状态跟踪

```typescript
type SessionState = {
  sessionId?: string;
  sessionKey?: string;
  lastActivity: number;
  state: "idle" | "processing" | "waiting";
  queueDepth: number;
};

export function logSessionStateChange(params: {
  sessionId?: string;
  sessionKey?: string;
  state: SessionStateValue;
  reason?: string;
});
```

## 核心代码位置

```
src/logging/
├── logger.ts:50-150           # 日志器构建
├── subsystem.ts:30-120        # 子系统日志器
├── levels.ts:10-50            # 级别定义
├── redact.ts:20-100           # 脱敏逻辑
├── console.ts:30-80           # 控制台捕获
├── diagnostic.ts:50-150       # 诊断日志
```

## 相关文档

- [基础设施模块](./基础设施模块分析.md)
- [配置系统](./配置系统分析.md)
- [Gateway 网关模块](./Gateway网关模块分析.md)
