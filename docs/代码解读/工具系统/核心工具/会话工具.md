# 会话工具

## 概述

会话工具提供会话管理能力，包括列出会话、获取历史、发送消息、创建子会话等功能。

## 工具列表

| 工具名称 | 功能描述 |
|---------|---------|
| `sessions_list` | 列出所有会话 |
| `sessions_history` | 获取会话历史 |
| `sessions_send` | 发送消息到会话 |
| `sessions_spawn` | 创建子会话/子 Agent |
| `session_status` | 获取当前会话状态 |

## sessions_list 工具

### 功能描述

列出所有活跃的会话，包括会话 ID、渠道、状态等信息。

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      sessions_list 执行流程                               │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 获取会话列表                                 │
     │  - 从 Gateway 获取活跃会话                                        │
     │  - 过滤沙箱会话 (如果在沙箱中)                                     │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 格式化结果                                   │
     │  - 会话 ID                                                       │
     │  - 渠道类型                                                      │
     │  - 目标 (用户/群组)                                               │
     │  - 状态                                                          │
     │  - 最后活动时间                                                   │
     └─────────────────────────────────────────────────────────────────┘
```

## sessions_history 工具

### 功能描述

获取指定会话的消息历史记录。

### 工具 Schema

```typescript
const SessionsHistorySchema = Type.Object({
  sessionKey: Type.String(),              // 会话密钥
  limit: Type.Optional(Type.Number()),    // 消息数量限制
  before: Type.Optional(Type.String()),   // 在此消息之前
  after: Type.Optional(Type.String()),    // 在此消息之后
});
```

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     sessions_history 执行流程                             │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 解析会话密钥                                 │
     │  - 验证会话存在                                                   │
     │  - 检查访问权限                                                   │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 获取消息历史                                 │
     │  - 从会话存储读取消息                                             │
     │  - 应用分页参数                                                   │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 格式化结果                                   │
     │  - 消息内容                                                      │
     │  - 发送者                                                        │
     │  - 时间戳                                                        │
     │  - 工具调用 (如有)                                                │
     └─────────────────────────────────────────────────────────────────┘
```

## sessions_send 工具

### 功能描述

向指定会话发送消息，支持跨会话通信。

### 工具 Schema

```typescript
const SessionsSendSchema = Type.Object({
  sessionKey: Type.String(),              // 目标会话密钥
  message: Type.String(),                 // 消息内容
  role: Type.Optional(Type.String()),     // 消息角色 (user/assistant)
});
```

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      sessions_send 执行流程                               │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 验证目标会话                                 │
     │  - 检查会话是否存在                                               │
     │  - 检查发送权限                                                   │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 构建消息                                    │
     │  - 设置消息角色                                                   │
     │  - 添加来源标记                                                   │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 发送消息                                    │
     │  - 通过 Gateway 发送                                             │
     │  - 触发目标会话处理                                               │
     └─────────────────────────────────────────────────────────────────┘
```

## sessions_spawn 工具

### 功能描述

创建子会话或子 Agent，用于并行处理任务或委托工作。

### 工具 Schema

```typescript
const SessionsSpawnSchema = Type.Object({
  prompt: Type.String(),                  // 子 Agent 提示
  agentId: Type.Optional(Type.String()),  // 使用的 Agent ID
  tools: Type.Optional(Type.Array(Type.String())),  // 允许的工具
  timeout: Type.Optional(Type.Number()),  // 超时时间
  background: Type.Optional(Type.Boolean()), // 是否后台执行
});
```

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      sessions_spawn 执行流程                              │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 解析参数                                    │
     │  - 提示内容                                                      │
     │  - Agent 配置                                                    │
     │  - 工具限制                                                      │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 创建子会话                                   │
     │  - 生成子会话密钥                                                 │
     │  - 继承父会话上下文                                               │
     │  - 应用子 Agent 工具策略                                          │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 启动子 Agent                                │
     │  - 同步执行: 等待完成并返回结果                                    │
     │  - 后台执行: 返回子会话 ID                                        │
     └─────────────────────────────────────────────────────────────────┘
```

### 子 Agent 工具限制

子 Agent 默认被拒绝使用以下工具：

```typescript
const DEFAULT_SUBAGENT_TOOL_DENY = [
  "sessions_list",
  "sessions_history",
  "sessions_send",
  "sessions_spawn",
  "gateway",
  "agents_list",
  "whatsapp_login",
  "session_status",
  "cron",
  "memory_search",
  "memory_get",
];
```

## session_status 工具

### 功能描述

获取当前会话的状态信息，包括配置、工具、上下文等。

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      session_status 执行流程                              │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 获取会话信息                                 │
     │  - 会话密钥                                                      │
     │  - Agent ID                                                      │
     │  - 渠道信息                                                      │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 获取配置信息                                 │
     │  - 模型配置                                                      │
     │  - 工具配置                                                      │
     │  - 策略配置                                                      │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 返回状态                                    │
     │  {                                                               │
     │    sessionKey,                                                   │
     │    agentId,                                                      │
     │    channel,                                                      │
     │    model,                                                        │
     │    tools: [...],                                                 │
     │    ...                                                           │
     │  }                                                               │
     └─────────────────────────────────────────────────────────────────┘
```

## 会话密钥格式

会话密钥用于唯一标识一个会话：

```
agent:<agent-id>:<channel>:<type>:<id>

示例:
- agent:default:telegram:user:123456789
- agent:default:discord:channel:987654321
- agent:default:slack:channel:C12345678:thread:1234567890.123456
- agent:default:subagent:<parent-session>:<spawn-id>
```

## 工具组归属

会话工具属于 `group:sessions` 工具组：

```typescript
"group:sessions": [
  "sessions_list",
  "sessions_history",
  "sessions_send",
  "sessions_spawn",
  "session_status",
]
```

## 核心代码位置

```
src/agents/tools/
├── sessions-list-tool.ts      # 会话列表工具
├── sessions-history-tool.ts   # 会话历史工具
├── sessions-send-tool.ts      # 会话发送工具
├── sessions-spawn-tool.ts     # 会话生成工具
├── session-status-tool.ts     # 会话状态工具
├── sessions-helpers.ts        # 会话辅助函数
└── sessions-send-helpers.ts   # 发送辅助函数
```

## 相关文档

- [核心工具](./README.md)
- [工具策略系统](../工具策略系统.md)
- [工具系统架构](../README.md)
