# 记忆工具 (memory_search & memory_get)

## 概述

记忆工具提供语义搜索和文件读取能力，让 AI Agent 能够访问和检索存储在记忆文件中的信息。

## 工具列表

| 工具名称 | 功能描述 |
|---------|---------|
| `memory_search` | 语义搜索记忆文件和会话记录 |
| `memory_get` | 安全读取记忆文件片段 |

## memory_search 工具

### 功能描述

语义搜索 MEMORY.md、memory/*.md 文件以及可选的会话记录，返回最相关的文本片段。

### 工具 Schema

```typescript
const MemorySearchSchema = Type.Object({
  query: Type.String(),                    // 搜索查询
  maxResults: Type.Optional(Type.Number()), // 最大结果数
  minScore: Type.Optional(Type.Number()),   // 最小相关度分数
});
```

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      memory_search 执行流程                               │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 参数解析                                    │
     │  - query: 搜索查询文本                                           │
     │  - maxResults: 最大返回结果数                                     │
     │  - minScore: 最小相关度阈值                                       │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 获取记忆搜索管理器                           │
     │  getMemorySearchManager({                                        │
     │    cfg,                                                          │
     │    agentId,                                                      │
     │  })                                                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 执行语义搜索                                 │
     │  manager.search(query, {                                         │
     │    maxResults,                                                   │
     │    minScore,                                                     │
     │    sessionKey,                                                   │
     │  })                                                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 返回结果                                    │
     │  {                                                               │
     │    results: [...],                                               │
     │    provider: "openai" | "local" | ...,                          │
     │    model: "text-embedding-3-small" | ...,                       │
     │    fallback: boolean,                                            │
     │  }                                                               │
     └─────────────────────────────────────────────────────────────────┘
```

### 搜索结果格式

```typescript
type MemorySearchResult = {
  path: string;      // 文件路径
  from: number;      // 起始行号
  to: number;        // 结束行号
  text: string;      // 匹配的文本片段
  score: number;     // 相关度分数 (0-1)
};
```

## memory_get 工具

### 功能描述

安全读取记忆文件的指定片段，用于在 memory_search 后获取更多上下文。

### 工具 Schema

```typescript
const MemoryGetSchema = Type.Object({
  path: Type.String(),                   // 文件路径
  from: Type.Optional(Type.Number()),    // 起始行号
  lines: Type.Optional(Type.Number()),   // 读取行数
});
```

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                       memory_get 执行流程                                 │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 参数解析                                    │
     │  - path: 相对文件路径                                            │
     │  - from: 起始行号 (可选)                                         │
     │  - lines: 读取行数 (可选)                                        │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 获取记忆搜索管理器                           │
     │  getMemorySearchManager({                                        │
     │    cfg,                                                          │
     │    agentId,                                                      │
     │  })                                                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 读取文件片段                                 │
     │  manager.readFile({                                              │
     │    relPath,                                                      │
     │    from,                                                         │
     │    lines,                                                        │
     │  })                                                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 返回结果                                    │
     │  {                                                               │
     │    path: string,                                                 │
     │    text: string,                                                 │
     │    from: number,                                                 │
     │    to: number,                                                   │
     │  }                                                               │
     └─────────────────────────────────────────────────────────────────┘
```

## 记忆搜索配置

### 启用记忆搜索

```yaml
# moltbot.yaml

memorySearch:
  enabled: true

  # 嵌入提供商
  provider: openai | local | ...

  # 嵌入模型
  model: text-embedding-3-small

  # 额外搜索路径
  extraPaths:
    - notes/*.md
    - docs/*.md

  # 是否索引会话记录
  indexSessions: true

  # 最大结果数
  maxResults: 10

  # 最小相关度分数
  minScore: 0.5
```

### Agent 特定配置

```yaml
agents:
  my-agent:
    memorySearch:
      enabled: true
      extraPaths:
        - agent-notes/*.md
```

## 记忆文件结构

```
~/.clawdbot/
├── MEMORY.md              # 主记忆文件
├── memory/
│   ├── notes.md           # 笔记
│   ├── preferences.md     # 偏好设置
│   └── todos.md           # 待办事项
└── agents/
    └── <agent-id>/
        ├── MEMORY.md      # Agent 特定记忆
        └── sessions/      # 会话记录
            └── *.jsonl
```

## 搜索架构

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          记忆搜索架构                                     │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    记忆搜索管理器                                  │
     │                 MemorySearchManager                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
     ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
     │   向量索引        │ │   BM25 索引      │ │   会话索引        │
     │ (语义搜索)        │ │ (关键词搜索)     │ │ (会话记录)        │
     └──────────────────┘ └──────────────────┘ └──────────────────┘
                    │               │               │
                    └───────────────┼───────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    混合搜索结果                                    │
     │  - 向量相似度 + BM25 分数                                        │
     │  - 结果去重和排序                                                │
     └─────────────────────────────────────────────────────────────────┘
```

## 使用示例

### 搜索记忆

```json
{
  "query": "用户的编程语言偏好",
  "maxResults": 5,
  "minScore": 0.6
}
```

### 读取记忆片段

```json
{
  "path": "memory/preferences.md",
  "from": 10,
  "lines": 20
}
```

## 工具启用条件

记忆工具只有在以下条件满足时才会创建：

1. 配置存在 (`config` 不为空)
2. Agent ID 可解析
3. 记忆搜索配置已启用

```typescript
export function createMemorySearchTool(options: {
  config?: MoltbotConfig;
  agentSessionKey?: string;
}): AnyAgentTool | null {
  const cfg = options.config;
  if (!cfg) return null;

  const agentId = resolveSessionAgentId({
    sessionKey: options.agentSessionKey,
    config: cfg,
  });

  if (!resolveMemorySearchConfig(cfg, agentId)) return null;

  // 创建工具...
}
```

## 核心代码位置

```
src/agents/tools/memory-tool.ts
src/memory/index.ts
```

## 相关文档

- [核心工具](./README.md)
- [工具系统架构](../README.md)
