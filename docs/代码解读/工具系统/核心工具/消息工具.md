# 消息工具 (message)

## 概述

消息工具是 Moltbot 的核心通信工具，提供跨渠道的消息发送、编辑、删除、反应等功能。

## 功能特性

- 跨渠道消息发送
- 消息编辑和删除
- 表情反应
- 消息固定
- 投票创建
- 线程管理
- 媒体附件
- 渠道特定操作

## 工具 Schema

```typescript
const MessageToolSchema = Type.Object({
  // 操作类型
  action: stringEnum([
    "send", "edit", "delete", "react", "pin", "unpin",
    "forward", "poll", "fetch_messages", "search_messages",
    // ... 更多操作
  ]),

  // 路由参数
  channel: Type.Optional(Type.String()),
  target: Type.Optional(channelTargetSchema()),
  targets: Type.Optional(channelTargetsSchema()),
  accountId: Type.Optional(Type.String()),
  dryRun: Type.Optional(Type.Boolean()),

  // 发送参数
  message: Type.Optional(Type.String()),
  media: Type.Optional(Type.String()),
  filename: Type.Optional(Type.String()),
  buffer: Type.Optional(Type.String()),
  contentType: Type.Optional(Type.String()),
  caption: Type.Optional(Type.String()),
  path: Type.Optional(Type.String()),
  replyTo: Type.Optional(Type.String()),
  threadId: Type.Optional(Type.String()),
  asVoice: Type.Optional(Type.Boolean()),
  silent: Type.Optional(Type.Boolean()),

  // 反应参数
  messageId: Type.Optional(Type.String()),
  emoji: Type.Optional(Type.String()),
  remove: Type.Optional(Type.Boolean()),

  // 投票参数
  pollQuestion: Type.Optional(Type.String()),
  pollOption: Type.Optional(Type.Array(Type.String())),
  pollDurationHours: Type.Optional(Type.Number()),
  pollMulti: Type.Optional(Type.Boolean()),

  // ... 更多参数
});
```

## 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        消息工具执行流程                                    │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 参数解析                                    │
     │  - 解析 action 类型                                              │
     │  - 解析目标渠道和用户                                             │
     │  - 解析消息内容和附件                                             │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 账户解析                                    │
     │  - 使用指定的 accountId                                          │
     │  - 或使用 Agent 默认账户                                          │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. Gateway 配置                                │
     │  - 解析 Gateway URL 和 Token                                     │
     │  - 设置超时时间                                                   │
     │  - 设置客户端信息                                                 │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 工具上下文                                   │
     │  - 当前频道 ID                                                   │
     │  - 当前线程时间戳                                                 │
     │  - 回复模式                                                      │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    5. 执行消息操作                                 │
     │  runMessageAction({                                              │
     │    cfg, action, params,                                          │
     │    defaultAccountId, gateway,                                    │
     │    toolContext, agentId, abortSignal                             │
     │  })                                                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    6. 返回结果                                    │
     │  - 成功: 返回操作结果                                             │
     │  - 失败: 返回错误信息                                             │
     └─────────────────────────────────────────────────────────────────┘
```

## 支持的操作

### 基本操作

| 操作 | 描述 | 参数 |
|-----|------|-----|
| `send` | 发送消息 | message, media, target |
| `edit` | 编辑消息 | messageId, message |
| `delete` | 删除消息 | messageId |
| `react` | 添加反应 | messageId, emoji |
| `pin` | 固定消息 | messageId |
| `unpin` | 取消固定 | messageId |

### 高级操作

| 操作 | 描述 | 支持渠道 |
|-----|------|---------|
| `forward` | 转发消息 | Telegram |
| `poll` | 创建投票 | Telegram, Discord |
| `fetch_messages` | 获取消息历史 | Discord, Slack |
| `search_messages` | 搜索消息 | Discord, Slack |
| `create_thread` | 创建线程 | Discord, Slack |

## 使用示例

### 发送文本消息

```json
{
  "action": "send",
  "channel": "telegram",
  "target": "123456789",
  "message": "Hello, World!"
}
```

### 发送媒体消息

```json
{
  "action": "send",
  "channel": "discord",
  "target": "channel:123456789",
  "message": "Check out this image!",
  "media": "/path/to/image.png"
}
```

### 添加反应

```json
{
  "action": "react",
  "channel": "slack",
  "messageId": "1234567890.123456",
  "emoji": "thumbsup"
}
```

### 创建投票

```json
{
  "action": "poll",
  "channel": "telegram",
  "target": "group:123456789",
  "pollQuestion": "What's your favorite color?",
  "pollOption": ["Red", "Blue", "Green"],
  "pollMulti": false
}
```

## 渠道特定功能

### Telegram

- 消息特效 (`effectId`)
- 静默消息 (`silent`)
- 引用文本 (`quoteText`)
- 贴纸发送

### Discord

- 内联键盘按钮 (`buttons`)
- 嵌入消息
- 线程管理
- 服务器管理

### Slack

- 自适应卡片 (`card`)
- 线程回复
- 频道管理

## 配置选项

```typescript
createMessageTool({
  // Agent 账户 ID
  agentAccountId?: string;

  // Agent 会话密钥
  agentSessionKey?: string;

  // Moltbot 配置
  config?: MoltbotConfig;

  // 当前频道 ID (用于自动线程)
  currentChannelId?: string;

  // 当前渠道提供商
  currentChannelProvider?: string;

  // 当前线程时间戳 (Slack)
  currentThreadTs?: string;

  // 回复模式
  replyToMode?: "off" | "first" | "all";

  // 是否已回复标记
  hasRepliedRef?: { value: boolean };
});
```

## 动态 Schema 构建

消息工具根据配置的渠道动态构建 Schema：

```typescript
function buildMessageToolSchema(cfg: MoltbotConfig) {
  // 获取所有渠道支持的操作
  const actions = listChannelMessageActions(cfg);

  // 检查是否支持按钮
  const includeButtons = supportsChannelMessageButtons(cfg);

  // 检查是否支持卡片
  const includeCards = supportsChannelMessageCards(cfg);

  return buildMessageToolSchemaFromActions(
    actions.length > 0 ? actions : ["send"],
    { includeButtons, includeCards }
  );
}
```

## 核心代码位置

```
src/agents/tools/message-tool.ts
```

## 相关文档

- [核心工具](./README.md)
- [渠道工具](../渠道工具/README.md)
- [工具系统架构](../README.md)
