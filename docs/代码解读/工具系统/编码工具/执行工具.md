# 执行工具 (exec & process)

## 概述

执行工具提供 Shell 命令执行和进程管理能力，是 Moltbot 最强大也最需要安全控制的工具之一。

## 工具列表

| 工具名称 | 功能描述 |
|---------|---------|
| `exec` | 执行 Shell 命令 |
| `process` | 管理后台进程 |

## exec 工具

### 功能描述

执行 Shell 命令，支持后台执行、超时控制、PTY 模式、沙箱执行等特性。

### 执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          exec 工具执行流程                                │
└──────────────────────────────────────────────────────────────────────────┘

     ┌───────────────────────���─────────────────────────────────────────┐
     │                    1. 参数解析                                    │
     │  - command: 要执行的命令                                          │
     │  - workdir: 工作目录                                             │
     │  - env: 环境变量                                                 │
     │  - yieldMs: 后台化等待时间                                        │
     │  - background: 是否立即后台执行                                    │
     │  - timeout: 超时时间 (秒)                                         │
     │  - pty: 是否使用 PTY                                             │
     │  - elevated: 是否提权执行                                         │
     │  - host: 执行主机 (sandbox|gateway|node)                         │
     │  - security: 安全模式 (deny|allowlist|full)                      │
     │  - ask: 询问模式 (off|on-miss|always)                            │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 安全检查                                    │
     │  - 检查 elevated 权限                                            │
     │  - 检查 host 权限                                                │
     │  - 解析 security 模式                                            │
     │  - 解析 ask 模式                                                 │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 工作目录解析                                 │
     │  - 沙箱模式: 映射到容器路径                                        │
     │  - 标准模式: 验证目录存在                                          │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 环境变量构建                                 │
     │  - 合并基础环境变量                                               │
     │  - 应用 PATH 前置                                                │
     │  - 沙箱环境变量处理                                               │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    5. 执行主机路由                                 │
     │                                                                  │
     │  ┌──────────┐  ┌──────────┐  ┌──────────┐                       │
     │  │ sandbox  │  │ gateway  │  │   node   │                       │
     │  │ (Docker) │  │ (本地)    │  │ (远程)   │                       │
     │  └────┬─────┘  └────┬─────┘  └────┬─────┘                       │
     │       │             │             │                              │
     │       ▼             ▼             ▼                              │
     │  Docker exec   本地 Shell    Gateway RPC                         │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    6. 审批流程 (如需要)                            │
     │  - 检查是否需要审批                                               │
     │  - 发送审批请求                                                   │
     │  - 等待审批结果                                                   │
     │  - 处理 allow-once / allow-always                               │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    7. 进程执行                                    │
     │  - 创建进程会话                                                   │
     │  - 启动进程 (PTY 或标准)                                          │
     │  - 收集输出                                                      │
     │  - 处理超时                                                      │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    8. 结果处理                                    │
     │  - 同步完成: 返回输出和退出码                                      │
     │  - 后台执行: 返回会话 ID                                          │
     │  - 审批等待: 返回审批 ID                                          │
     └─────────────────────────────────────────────────────────────────┘
```

### 参数 Schema

```typescript
const execSchema = Type.Object({
  command: Type.String({ description: "Shell command to execute" }),
  workdir: Type.Optional(Type.String({ description: "Working directory (defaults to cwd)" })),
  env: Type.Optional(Type.Record(Type.String(), Type.String())),
  yieldMs: Type.Optional(Type.Number({
    description: "Milliseconds to wait before backgrounding (default 10000)",
  })),
  background: Type.Optional(Type.Boolean({ description: "Run in background immediately" })),
  timeout: Type.Optional(Type.Number({
    description: "Timeout in seconds (optional, kills process on expiry)",
  })),
  pty: Type.Optional(Type.Boolean({
    description: "Run in a pseudo-terminal (PTY) when available",
  })),
  elevated: Type.Optional(Type.Boolean({
    description: "Run on the host with elevated permissions (if allowed)",
  })),
  host: Type.Optional(Type.String({
    description: "Exec host (sandbox|gateway|node).",
  })),
  security: Type.Optional(Type.String({
    description: "Exec security mode (deny|allowlist|full).",
  })),
  ask: Type.Optional(Type.String({
    description: "Exec ask mode (off|on-miss|always).",
  })),
  node: Type.Optional(Type.String({
    description: "Node id/name for host=node.",
  })),
});
```

### 执行主机类型

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          执行主机类型                                     │
└──────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         sandbox (沙箱)                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  - 在 Docker 容器中执行                                                  │
│  - 最安全的执行环境                                                      │
│  - 文件系统隔离                                                          │
│  - 网络可配置隔离                                                        │
│                                                                         │
│  docker exec -i <container> /bin/sh -c "<command>"                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         gateway (网关)                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  - 在本地主机执行                                                        │
│  - 需要审批机制保护                                                      │
│  - 支持 allowlist 控制                                                  │
│  - 支持 PTY 模式                                                        │
│                                                                         │
│  /bin/sh -c "<command>"                                                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                           node (节点)                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  - 在远程节点执行                                                        │
│  - 通过 Gateway RPC 调用                                                │
│  - 需要节点支持 system.run 命令                                          │
│  - 适用于分布式场景                                                      │
│                                                                         │
│  Gateway → Node → system.run                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

### 安全模式

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          安全模式 (security)                              │
└──────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                            deny (拒绝)                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  - 拒绝所有命令执行                                                      │
│  - 最严格的安全模式                                                      │
│  - 适用于只读场景                                                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         allowlist (白名单)                               │
├─────────────────────────────────────────────────────────────────────────┤
│  - 只允许白名单中的命令                                                   │
│  - 支持模式匹配                                                          │
│  - 支持 safeBins 安全二进制列表                                          │
│  - 推荐的生产环境模式                                                    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                            full (完全)                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  - 允许所有命令执行                                                      │
│  - 最宽松的安全模式                                                      │
│  - 仅适用于受信任环境                                                    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 询问模式

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          询问模式 (ask)                                   │
└──────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                             off (关闭)                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  - 不询问用户                                                            │
│  - 直接根据 security 模式决定                                            │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          on-miss (未命中时)                              │
├─────────────────────────────────────────────────────────────────────────┤
│  - 当命令不在白名单时询问                                                 │
│  - 用户可选择 allow-once 或 allow-always                                │
│  - allow-always 会添加到白名单                                           │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          always (总是)                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  - 每次执行都询问用户                                                    │
│  - 最严格的交互模式                                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 审批流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          审批流程                                        │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 检查是否需要审批                             │
     │  requiresExecApproval({                                          │
     │    ask,                                                          │
     │    security,                                                     │
     │    analysisOk,                                                   │
     │    allowlistSatisfied,                                           │
     │  })                                                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 发送审批请求                                 │
     │  callGatewayTool("exec.approval.request", {                      │
     │    id: approvalId,                                               │
     │    command,                                                      │
     │    cwd,                                                          │
     │    host,                                                         │
     │    security,                                                     │
     │    ask,                                                          │
     │    agentId,                                                      │
     │    timeoutMs,                                                    │
     │  })                                                              │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 等待用户决定                                 │
     │  - deny: 拒绝执行                                                │
     │  - allow-once: 允许本次执行                                       │
     │  - allow-always: 允许并添加到白名单                                │
     │  - timeout: 超时处理 (根据 askFallback)                           │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 执行或拒绝                                   │
     │  - 审批通过: 执行命令                                             │
     │  - 审批拒绝: 返回错误                                             │
     │  - 超时: 根据 askFallback 决定                                    │
     └─────────────────────────────────────────────────────────────────┘
```

### 返回结果类型

```typescript
export type ExecToolDetails =
  | {
      status: "running";
      sessionId: string;
      pid?: number;
      startedAt: number;
      cwd?: string;
      tail?: string;
    }
  | {
      status: "completed" | "failed";
      exitCode: number | null;
      durationMs: number;
      aggregated: string;
      cwd?: string;
    }
  | {
      status: "approval-pending";
      approvalId: string;
      approvalSlug: string;
      expiresAtMs: number;
      host: ExecHost;
      command: string;
      cwd?: string;
      nodeId?: string;
    };
```

## process 工具

### 功能描述

管理后台进程，包括列出、轮询、查看日志、写入输入、终止等操作。

### 操作类型

| 操作 | 描述 |
|-----|------|
| `list` | 列出所有后台进程 |
| `poll` | 轮询进程状态 |
| `log` | 查看进程输出日志 |
| `write` | 向进程写入输入 |
| `kill` | 终止进程 |
| `clear` | 清除进程输出缓冲 |
| `remove` | 移除已完成的进程记录 |

### 参数 Schema

```typescript
const processSchema = Type.Object({
  action: Type.String({
    description: "Action: list, poll, log, write, kill, clear, remove",
  }),
  sessionId: Type.Optional(Type.String({
    description: "Session ID for poll/log/write/kill/clear/remove",
  })),
  input: Type.Optional(Type.String({
    description: "Input to write (for write action)",
  })),
  signal: Type.Optional(Type.String({
    description: "Signal to send (for kill action, default SIGTERM)",
  })),
});
```

## 配置选项

### exec 工具配置

```yaml
# moltbot.yaml

tools:
  exec:
    # 执行主机
    host: sandbox | gateway | node

    # 安全模式
    security: deny | allowlist | full

    # 询问模式
    ask: off | on-miss | always

    # 默认节点 (host=node 时)
    node: node-id

    # PATH 前置目录
    pathPrepend:
      - /usr/local/bin
      - ~/.local/bin

    # 安全二进制列表
    safeBins:
      - git
      - npm
      - node

    # 后台化等待时间 (毫秒)
    backgroundMs: 10000

    # 默认超时 (秒)
    timeoutSec: 1800

    # 审批运行通知时间 (毫秒)
    approvalRunningNoticeMs: 10000

    # 进程清理时间 (毫秒)
    cleanupMs: 300000

    # 退出时通知
    notifyOnExit: true

    # apply_patch 配置
    applyPatch:
      enabled: true
      allowModels:
        - openai/gpt-4
        - openai/gpt-4-turbo
```

### 提权配置

```yaml
tools:
  elevated:
    enabled: true
    allowFrom:
      telegram: true
      discord: false
    defaultLevel: ask  # on | off | ask | full
```

## 核心代码位置

```
src/agents/
├── bash-tools.ts            # 入口文件
├── bash-tools.exec.ts       # exec 工具实现
├── bash-tools.process.ts    # process 工具实现
├── bash-tools.shared.ts     # 共享函数
└── bash-process-registry.ts # 进程会话注册表
```

## 相关文档

- [编码工具](./README.md)
- [工具策略系统](../工具策略系统.md)
- [工具系统架构](../README.md)
