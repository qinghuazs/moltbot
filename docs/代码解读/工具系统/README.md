# Moltbot 工具系统架构

## 概述

Moltbot 的工具系统是一个分层、可扩展的架构，为 AI Agent 提供与外部世界交互的能力。工具系统支持核心工具、编码工具、渠道工具和插件工具四大类别。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           工具系统架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        工具策略层 (Tool Policy)                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ 全局策略  │ │ Agent策略│ │ 群组策略  │ │ 沙箱策略  │ │子Agent策略│  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        工具过滤与规范化                                │   │
│  │  filterToolsByPolicy() → normalizeToolParameters() → wrapAbortSignal │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           工具集合                                    │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │  核心工具    │ │  编码工具    │ │  渠道工具    │ │  插件工具    │   │   │
│  │  │ (Moltbot)   │ │ (pi-agent)  │ │ (Channel)   │ │ (Plugin)    │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      工具定义适配器                                    │   │
│  │              toToolDefinitions() / toClientToolDefinitions()          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        AI Provider                                    │   │
│  │         (Anthropic / OpenAI / Google / Azure / 其他)                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 工具分类

### 1. 核心工具 (Moltbot Native Tools)

Moltbot 原生工具，提供系统级功能：

| 工具名称 | 功能描述 | 文档链接 |
|---------|---------|---------|
| `message` | 跨渠道消息发送和管理 | [消息工具](./核心工具/消息工具.md) |
| `memory_search` | 语义搜索记忆文件 | [记忆工具](./核心工具/记忆工具.md) |
| `memory_get` | 读取记忆文件片段 | [记忆工具](./核心工具/记忆工具.md) |
| `web_search` | 网络搜索 | [网络工具](./核心工具/网络工具.md) |
| `web_fetch` | 网页内容抓取 | [网络工具](./核心工具/网络工具.md) |
| `browser` | 浏览器控制 | [浏览器工具](./核心工具/浏览器工具.md) |
| `canvas` | 画布操作 | [画布工具](./核心工具/画布工具.md) |
| `sessions_*` | 会话管理 | [会话工具](./核心工具/会话工具.md) |
| `cron` | 定时任务 | [自动化工具](./核心工具/自动化工具.md) |
| `gateway` | 网关控制 | [自动化工具](./核心工具/自动化工具.md) |
| `nodes` | 节点管理 | [节点工具](./核心工具/节点工具.md) |
| `image` | 图像处理 | [媒体工具](./核心工具/媒体工具.md) |
| `tts` | 文本转语音 | [媒体工具](./核心工具/媒体工具.md) |

### 2. 编码工具 (Coding Tools)

基于 `@mariozechner/pi-coding-agent` 的文件操作和执行工具：

| 工具名称 | 功能描述 | 文档链接 |
|---------|---------|---------|
| `read` | 文件读取 | [编码工具](./编码工具/README.md) |
| `write` | 文件写入 | [编码工具](./编码工具/README.md) |
| `edit` | 文件编辑 | [编码工具](./编码工具/README.md) |
| `exec` | 命令执行 | [执行工具](./编码工具/执行工具.md) |
| `process` | 进程管理 | [执行工具](./编码工具/执行工具.md) |
| `apply_patch` | 补丁应用 | [编码工具](./编码工具/README.md) |

### 3. 渠道工具 (Channel Tools)

渠道特定的操作工具：

| 渠道 | 工具类型 | 文档链接 |
|-----|---------|---------|
| Discord | 消息、审核、服务器管理 | [渠道工具](./渠道工具/README.md) |
| Telegram | 消息、投票、贴纸 | [渠道工具](./渠道工具/README.md) |
| Slack | 消息、线程、频道 | [渠道工具](./渠道工具/README.md) |
| WhatsApp | 消息、群组 | [渠道工具](./渠道工具/README.md) |

### 4. 插件工具 (Plugin Tools)

通过插件系统动态加载的工具：

详见 [插件工具](./插件工具/README.md)

## 核心文件结构

```
src/
├── agents/
│   ├── tool-policy.ts          # 工具策略定义和分组
│   ├── moltbot-tools.ts        # Moltbot 核心工具集创建
│   ├── pi-tools.ts             # 完整编码工具集创建
│   ├── pi-tools.policy.ts      # 工具策略解析和应用
│   ├── pi-tools.types.ts       # 工具类型定义
│   ├── bash-tools.ts           # Bash 执行工具入口
│   ├── bash-tools.exec.ts      # exec 工具实现
│   ├── bash-tools.process.ts   # process 工具实现
│   ├── channel-tools.ts        # 渠道工具管理
│   ├── pi-tool-definition-adapter.ts  # 工具定义适配器
│   └── tools/                  # 具体工具实现
│       ├── common.ts           # 通用工具辅助函数
│       ├── message-tool.ts     # 消息工具
│       ├── memory-tool.ts      # 记忆工具
│       ├── web-tools.ts        # 网络工具
│       ├── browser-tool.ts     # 浏览器工具
│       ├── canvas-tool.ts      # 画布工具
│       ├── sessions-*.ts       # 会话管理工具
│       ├── cron-tool.ts        # 定时任务工具
│       ├── gateway-tool.ts     # 网关工具
│       ├── nodes-tool.ts       # 节点工具
│       ├── image-tool.ts       # 图像工具
│       ├── tts-tool.ts         # TTS 工具
│       └── *-actions.ts        # 渠道特定操作
├── config/
│   └── types.tools.ts          # 工具配置类型定义
└── plugins/
    ├── tools.ts                # 插件工具解析
    ├── types.ts                # 插件类型定义
    └── runtime/
        └── types.ts            # 插件运行时类型
```

## 工具执行流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          工具执行流程                                      │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────┐
     │  AI Model   │
     │ (工具调用)   │
     └──────┬──────┘
            │
            ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 工具调用解析                                │
     │  - 解析工具名称和参数                                             │
     │  - 规范化工具名称 (normalizeToolName)                            │
     └─────────────────────────────────────────────────────────────────┘
            │
            ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 策略检查                                    │
     │  - 检查工具是否在允许列表中                                        │
     │  - 检查工具是否被拒绝                                             │
     │  - 应用配置文件策略                                               │
     └─────────────────────────────────────────────────────────────────┘
            │
            ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 参数规范化                                  │
     │  - 类型转换和验证                                                 │
     │  - 默认值填充                                                    │
     │  - 安全检查                                                      │
     └─────────────────────────────────────────────────────────────────┘
            │
            ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 工具执行                                    │
     │  - 调用工具的 execute 函数                                        │
     │  - 处理中止信号                                                   │
     │  - 捕获错误                                                      │
     └─────────────────────────────────────────────────────────────────┘
            │
            ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    5. 结果处理                                    │
     │  - 格式化输出                                                    │
     │  - 图像处理                                                      │
     │  - 返回给 AI Model                                               │
     └─────────────────────────────────────────────────────────────────┘
            │
            ▼
     ┌─────────────┐
     │  AI Model   │
     │ (处理结果)   │
     └─────────────┘
```

## 工具策略系统

工具策略系统控制哪些工具可以被使用。策略按以下优先级应用：

1. **配置文件策略** (`tools.profile`)
2. **提供商配置文件策略** (`tools.byProvider[provider].profile`)
3. **全局策略** (`tools.allow`, `tools.deny`)
4. **全局提供商策略** (`tools.byProvider[provider].allow/deny`)
5. **Agent 策略** (`agents[id].tools.allow/deny`)
6. **Agent 提供商策略** (`agents[id].tools.byProvider[provider]`)
7. **群组策略** (基于渠道、群组 ID、发送者)
8. **沙箱策略** (`tools.sandbox.tools`)
9. **子 Agent 策略** (`tools.subagents.tools`)

详见 [工具策略系统](./工具策略系统.md)

## 工具组定义

系统预定义了以下工具组：

| 组名 | 包含工具 |
|-----|---------|
| `group:memory` | memory_search, memory_get |
| `group:web` | web_search, web_fetch |
| `group:fs` | read, write, edit, apply_patch |
| `group:runtime` | exec, process |
| `group:sessions` | sessions_list, sessions_history, sessions_send, sessions_spawn, session_status |
| `group:ui` | browser, canvas |
| `group:automation` | cron, gateway |
| `group:messaging` | message |
| `group:nodes` | nodes |
| `group:moltbot` | 所有 Moltbot 原生工具 |

## 工具配置文件

系统提供四种预定义的工具配置文件：

| 配置文件 | 允许的工具 |
|---------|-----------|
| `minimal` | session_status |
| `coding` | group:fs, group:runtime, group:sessions, group:memory, image |
| `messaging` | group:messaging, sessions_list, sessions_history, sessions_send, session_status |
| `full` | 所有工具 |

## 相关文档

- [工具策略系统](./工具策略系统.md)
- [核心工具](./核心工具/README.md)
- [编码工具](./编码工具/README.md)
- [渠道工具](./渠道工具/README.md)
- [插件工具](./插件工具/README.md)
