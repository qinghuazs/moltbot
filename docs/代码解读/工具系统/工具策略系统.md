# 工具策略系统

## 概述

工具策略系统是 Moltbot 的核心安全机制，用于控制 AI Agent 可以使用哪些工具。通过灵活的策略配置，可以实现细粒度的工具访问控制。

## 策略架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           工具策略层级                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  优先级从高到低:                                                              │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 配置文件策略 (Profile Policy)                                      │   │
│  │    tools.profile: "minimal" | "coding" | "messaging" | "full"        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2. 提供商配置文件策略 (Provider Profile Policy)                        │   │
│  │    tools.byProvider[provider].profile                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3. 全局策略 (Global Policy)                                          │   │
│  │    tools.allow / tools.deny                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4. 全局提供商策略 (Global Provider Policy)                            │   │
│  │    tools.byProvider[provider].allow / deny                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 5. Agent 策略 (Agent Policy)                                         │   │
│  │    agents[id].tools.allow / deny                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 6. Agent 提供商策略 (Agent Provider Policy)                           │   │
│  │    agents[id].tools.byProvider[provider].allow / deny                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 7. 群组策略 (Group Policy)                                           │   │
│  │    基于渠道、群组 ID、发送者的策略                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 8. 沙箱策略 (Sandbox Policy)                                         │   │
│  │    tools.sandbox.tools.allow / deny                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 9. 子 Agent 策略 (Subagent Policy)                                   │   │
│  │    tools.subagents.tools.allow / deny                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 策略解析流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          策略解析流程                                      │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    resolveEffectiveToolPolicy()                  │
     │  - 解析 agentId                                                  │
     │  - 获取全局策略                                                   │
     │  - 获取 Agent 策略                                               │
     │  - 获取提供商策略                                                 │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    resolveGroupToolPolicy()                      │
     │  - 解析群组上下文                                                 │
     │  - 获取渠道 Dock 策略                                            │
     │  - 获取渠道群组策略                                               │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    resolveSubagentToolPolicy()                   │
     │  - 应用默认子 Agent 拒绝列表                                       │
     │  - 合并配置的子 Agent 策略                                        │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    expandToolGroups()                            │
     │  - 展开工具组 (如 group:fs → read, write, edit, apply_patch)     │
     │  - 展开插件组                                                    │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    filterToolsByPolicy()                         │
     │  - 按策略过滤工具列表                                             │
     │  - 应用 allow/deny 规则                                          │
     └─────────────────────────────────────────────────────────────────┘
```

## 核心代码位置

| 文件 | 功能 |
|-----|------|
| `src/agents/tool-policy.ts` | 工具策略定义、工具组、配置文件 |
| `src/agents/pi-tools.policy.ts` | 策略解析和应用逻辑 |
| `src/config/types.tools.ts` | 工具配置类型定义 |

## 工具组定义

工具组允许批量配置工具权限：

```typescript
// src/agents/tool-policy.ts

export const TOOL_GROUPS: Record<string, string[]> = {
  // 记忆工具组
  "group:memory": ["memory_search", "memory_get"],

  // 网络工具组
  "group:web": ["web_search", "web_fetch"],

  // 文件系统工具组
  "group:fs": ["read", "write", "edit", "apply_patch"],

  // 运行时工具组
  "group:runtime": ["exec", "process"],

  // 会话管理工具组
  "group:sessions": [
    "sessions_list",
    "sessions_history",
    "sessions_send",
    "sessions_spawn",
    "session_status",
  ],

  // UI 工具组
  "group:ui": ["browser", "canvas"],

  // 自动化工具组
  "group:automation": ["cron", "gateway"],

  // 消息工具组
  "group:messaging": ["message"],

  // 节点工具组
  "group:nodes": ["nodes"],

  // 所有 Moltbot 原生工具
  "group:moltbot": [
    "browser", "canvas", "nodes", "cron", "message",
    "gateway", "agents_list", "sessions_list",
    "sessions_history", "sessions_send", "sessions_spawn",
    "session_status", "memory_search", "memory_get",
    "web_search", "web_fetch", "image",
  ],
};
```

## 配置文件定义

预定义的工具配置文件：

```typescript
// src/agents/tool-policy.ts

const TOOL_PROFILES: Record<ToolProfileId, ToolProfilePolicy> = {
  // 最小配置 - 仅状态查询
  minimal: {
    allow: ["session_status"],
  },

  // 编码配置 - 文件操作和执行
  coding: {
    allow: ["group:fs", "group:runtime", "group:sessions", "group:memory", "image"],
  },

  // 消息配置 - 消息发送和会话管理
  messaging: {
    allow: [
      "group:messaging",
      "sessions_list",
      "sessions_history",
      "sessions_send",
      "session_status",
    ],
  },

  // 完整配置 - 所有工具
  full: {},
};
```

## 子 Agent 默认拒绝列表

子 Agent 默认被拒绝使用以下工具：

```typescript
// src/agents/pi-tools.policy.ts

const DEFAULT_SUBAGENT_TOOL_DENY = [
  // 会话管理 - 主 Agent 协调
  "sessions_list",
  "sessions_history",
  "sessions_send",
  "sessions_spawn",

  // 系统管理 - 子 Agent 不应访问
  "gateway",
  "agents_list",

  // 交互式设置 - 不是任务
  "whatsapp_login",

  // 状态/调度 - 主 Agent 协调
  "session_status",
  "cron",

  // 记忆 - 应在 spawn 提示中传递相关信息
  "memory_search",
  "memory_get",
];
```

## 策略匹配规则

策略支持三种匹配模式：

```typescript
// src/agents/pi-tools.policy.ts

type CompiledPattern =
  | { kind: "all" }           // "*" - 匹配所有
  | { kind: "exact"; value: string }  // 精确匹配
  | { kind: "regex"; value: RegExp }; // 通配符匹配 (如 "web_*")
```

### 匹配逻辑

```typescript
function makeToolPolicyMatcher(policy: SandboxToolPolicy) {
  const deny = compilePatterns(policy.deny);
  const allow = compilePatterns(policy.allow);

  return (name: string) => {
    const normalized = normalizeToolName(name);

    // 1. 如果在拒绝列表中，返回 false
    if (matchesAny(normalized, deny)) return false;

    // 2. 如果没有允许列表，返回 true
    if (allow.length === 0) return true;

    // 3. 如果在允许列表中，返回 true
    if (matchesAny(normalized, allow)) return true;

    // 4. apply_patch 特殊处理：如果 exec 被允许，apply_patch 也被允许
    if (normalized === "apply_patch" && matchesAny("exec", allow)) return true;

    return false;
  };
}
```

## 配置示例

### 基本配置

```yaml
# moltbot.yaml

tools:
  # 使用预定义配置文件
  profile: coding

  # 额外允许的工具
  alsoAllow:
    - web_search
    - web_fetch

  # 拒绝的工具
  deny:
    - gateway
```

### 按提供商配置

```yaml
tools:
  byProvider:
    openai:
      profile: coding
      allow:
        - apply_patch
    anthropic:
      profile: full
```

### Agent 特定配置

```yaml
agents:
  my-agent:
    tools:
      profile: messaging
      allow:
        - group:web
      deny:
        - cron
```

### 群组策略配置

```yaml
channels:
  telegram:
    groups:
      "123456789":
        tools:
          allow:
            - message
            - web_search
          deny:
            - exec
```

### 沙箱配置

```yaml
tools:
  sandbox:
    tools:
      allow:
        - group:fs
        - group:runtime
      deny:
        - gateway
        - nodes
```

### 子 Agent 配置

```yaml
tools:
  subagents:
    tools:
      allow:
        - group:fs
        - group:runtime
      deny:
        - cron
        - gateway
```

## 工具名称别名

系统支持工具名称别名：

```typescript
const TOOL_NAME_ALIASES: Record<string, string> = {
  bash: "exec",
  "apply-patch": "apply_patch",
};
```

## 策略检查函数

### isToolAllowedByPolicies

检查工具是否被所有策略允许：

```typescript
export function isToolAllowedByPolicies(
  name: string,
  policies: Array<SandboxToolPolicy | undefined>,
) {
  return policies.every((policy) => isToolAllowedByPolicyName(name, policy));
}
```

### filterToolsByPolicy

根据策略过滤工具列表：

```typescript
export function filterToolsByPolicy(tools: AnyAgentTool[], policy?: SandboxToolPolicy) {
  if (!policy) return tools;
  const matcher = makeToolPolicyMatcher(policy);
  return tools.filter((tool) => matcher(tool.name));
}
```

## 插件工具策略

插件工具支持特殊的组标识：

- `group:plugins` - 所有插件工具
- `<plugin-id>` - 特定插件的所有工具

```typescript
// 允许所有插件工具
tools:
  allow:
    - group:plugins

// 允许特定插件的工具
tools:
  allow:
    - my-plugin
```

## 最佳实践

1. **最小权限原则**: 只授予必要的工具权限
2. **使用配置文件**: 优先使用预定义配置文件
3. **分层配置**: 利用策略层级实现细粒度控制
4. **子 Agent 限制**: 子 Agent 应有更严格的限制
5. **沙箱隔离**: 在沙箱环境中限制危险工具

## 相关文档

- [工具系统架构](./README.md)
- [核心工具](./核心工具/README.md)
- [编码工具](./编码工具/README.md)
