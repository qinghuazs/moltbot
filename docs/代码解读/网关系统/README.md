# 网关系统

## 概述

网关系统是 Moltbot 的核心通信枢纽，提供 WebSocket 服务、HTTP API、设备认证、RPC 调用等功能。它是连接各个组件（渠道、Agent、客户端应用）的中心节点。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           网关系统架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        客户端连接                                     │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ Mac App  │ │ iOS App  │ │ Web UI   │ │ CLI      │ │ Node     │  │   │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘  │   │
│  │       │            │            │            │            │         │   │
│  │       └────────────┴────────────┴────────────┴────────────┘         │   │
│  │                                 │                                    │   │
│  └─────────────────────────────────┼────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Gateway Server                                │   │
│  │                                                                      │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │                    WebSocket Server                           │   │   │
│  │  │  - 客户端连接管理                                              │   │   │
│  │  │  - 协议版本协商                                                │   │   │
│  │  │  - 心跳检测                                                   │   │   │
│  │  │  - 消息序列号                                                 │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │                    HTTP Server                                │   │   │
│  │  │  - OpenAI 兼容 API (/v1/chat/completions)                    │   │   │
│  │  │  - Open Responses API                                        │   │   │
│  │  │  - 健康检查 (/health)                                         │   │   │
│  │  │  - 控制 UI                                                    │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │                    RPC Methods                                │   │   │
│  │  │  - agent.*      (Agent 管理)                                  │   │   │
│  │  │  - chat.*       (聊天会话)                                    │   │   │
│  │  │  - channels.*   (渠道管理)                                    │   │   │
│  │  │  - config.*     (配置管理)                                    │   │   │
│  │  │  - sessions.*   (会话管理)                                    │   │   │
│  │  │  - nodes.*      (节点管理)                                    │   │   │
│  │  │  - cron.*       (定时任务)                                    │   │   │
│  │  │  - exec.*       (命令执行)                                    │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        后端服务                                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ Channels │ │ Agents   │ │ Sessions │ │ Config   │ │ Plugins  │  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. WebSocket 服务器

WebSocket 服务器处理客户端连接和实时通信。

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      WebSocket 连接流程                                   │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 建立连接                                    │
     │  - TLS 握手 (如果是 wss://)                                      │
     │  - TLS 指纹验证                                                  │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 发送 Connect 帧                             │
     │  {                                                               │
     │    type: "connect",                                              │
     │    protocol: 1,                                                  │
     │    auth: { token, password },                                    │
     │    device: { publicKey, signature, ... },                        │
     │    client: { name, version, mode, ... },                         │
     │  }                                                               │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 服务器验证                                   │
     │  - 验证 token/password                                           │
     │  - 验证设备签名                                                   │
     │  - 检查权限                                                      │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 返回 HelloOk                                │
     │  {                                                               │
     │    type: "hello_ok",                                             │
     │    protocol: 1,                                                  │
     │    clientId: "...",                                              │
     │    deviceToken: "...",                                           │
     │    caps: [...],                                                  │
     │  }                                                               │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    5. 开始通信                                    │
     │  - 发送/接收 Request/Response 帧                                 │
     │  - 接收 Event 帧                                                 │
     │  - 心跳检测                                                      │
     └─────────────────────────────────────────────────────────────────┘
```

### 2. 协议帧类型

```typescript
// 请求帧
type RequestFrame = {
  type: "request";
  id: string;           // 请求 ID
  method: string;       // 方法名
  params?: unknown;     // 参数
};

// 响应帧
type ResponseFrame = {
  type: "response";
  id: string;           // 对应的请求 ID
  result?: unknown;     // 成功结果
  error?: {             // 错误信息
    code: number;
    message: string;
  };
  final?: boolean;      // 是否为最终响应
};

// 事件帧
type EventFrame = {
  type: "event";
  seq: number;          // 序列号
  event: string;        // 事件名
  data?: unknown;       // 事件数据
};
```

### 3. HTTP API

#### OpenAI 兼容 API

```
POST /v1/chat/completions

{
  "model": "claude-3-5-sonnet",
  "messages": [
    { "role": "user", "content": "Hello" }
  ],
  "stream": true
}
```

#### Open Responses API

```
POST /v1/responses

{
  "model": "claude-3-5-sonnet",
  "input": "Hello",
  "instructions": "You are a helpful assistant"
}
```

#### 健康检查

```
GET /health

{
  "status": "ok",
  "version": "2024.1.1",
  "uptime": 3600
}
```

## RPC 方法

### Agent 方法

| 方法 | 描述 |
|-----|------|
| `agent.run` | 运行 Agent |
| `agent.abort` | 中止 Agent |
| `agent.status` | 获取 Agent 状态 |
| `agents.list` | 列出所有 Agent |
| `agents.models` | 获取可用模型 |
| `agents.skills` | 获取 Agent 技能 |

### 聊天方法

| 方法 | 描述 |
|-----|------|
| `chat.send` | 发送消息 |
| `chat.history` | 获取历史 |
| `chat.abort` | 中止聊天 |

### 渠道方法

| 方法 | 描述 |
|-----|------|
| `channels.list` | 列出渠道 |
| `channels.status` | 渠道状态 |
| `channels.connect` | 连接渠道 |
| `channels.disconnect` | 断开渠道 |

### 会话方法

| 方法 | 描述 |
|-----|------|
| `sessions.list` | 列出会话 |
| `sessions.get` | 获取会话 |
| `sessions.history` | 会话历史 |
| `sessions.send` | 发送到会话 |

### 配置方法

| 方法 | 描述 |
|-----|------|
| `config.get` | 获取配置 |
| `config.set` | 设置配置 |
| `config.reload` | 重载配置 |

### 节点方法

| 方法 | 描述 |
|-----|------|
| `nodes.list` | 列出节点 |
| `nodes.invoke` | 调用节点命令 |
| `nodes.status` | 节点状态 |

### 执行审批方法

| 方法 | 描述 |
|-----|------|
| `exec.approval.request` | 请求执行审批 |
| `exec.approval.respond` | 响应审批 |
| `exec.approvals.list` | 列出审批 |

## 设备认证

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        设备认证流程                                       │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 生成设备身份                                 │
     │  - 生成 Ed25519 密钥对                                           │
     │  - 生成设备 ID                                                   │
     │  - 存储到 ~/.clawdbot/device-identity.json                       │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 构建认证载荷                                 │
     │  {                                                               │
     │    deviceId: "...",                                              │
     │    publicKey: "...",                                             │
     │    signedAtMs: 1234567890,                                       │
     │    nonce: "...",                                                 │
     │    signature: "...",                                             │
     │  }                                                               │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 服务器验证                                   │
     │  - 验证签名                                                      │
     │  - 检查时间戳                                                    │
     │  - 检查 nonce                                                    │
     │  - 检查设备是否已授权                                             │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    4. 返回设备令牌                                 │
     │  - 生成 JWT 令牌                                                 │
     │  - 客户端存储令牌                                                 │
     │  - 后续连接使用令牌                                               │
     └─────────────────────────────────────────────────────────────────┘
```

## 客户端类型

```typescript
// 客户端名称
type GatewayClientName =
  | "mac-app"
  | "ios-app"
  | "android-app"
  | "web-ui"
  | "cli"
  | "gateway-client"
  | "node"
  | "unknown";

// 客户端模式
type GatewayClientMode =
  | "frontend"    // 前端 UI
  | "backend"     // 后端服务
  | "node"        // 远程节点
  | "unknown";
```

## 事件系统

网关支持以下事件类型：

| 事件 | 描述 |
|-----|------|
| `chat.message` | 聊天消息 |
| `chat.typing` | 正在输入 |
| `chat.tool_call` | 工具调用 |
| `chat.tool_result` | 工具结果 |
| `agent.status` | Agent 状态变化 |
| `channel.status` | 渠道状态变化 |
| `config.changed` | 配置变化 |
| `exec.approval` | 执行审批请求 |

## 配置热重载

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        配置热重载流程                                     │
└──────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    1. 检测配置变化                                 │
     │  - 文件系统监听                                                   │
     │  - 定期轮询                                                      │
     │  - 手动触发                                                      │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    2. 验证新配置                                   │
     │  - 解析配置文件                                                   │
     │  - 验证配置格式                                                   │
     │  - 检查配置兼容性                                                 │
     └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    3. 应用新配置                                   │
     │  - 更新内存配置                                                   │
     │  - 重新初始化受影响的组件                                          │
     │  - 广播配置变化事件                                               │
     └─────────────────────────────────────────────────────────────────┘
```

## 核心代码位置

```
src/gateway/
├── client.ts                    # WebSocket 客户端
├── server-*.ts                  # 服务器组件
├── auth.ts                      # 认证逻辑
├── call.ts                      # RPC 调用处理
├── hooks.ts                     # 钩子系统
├── openai-http.ts               # OpenAI 兼容 API
├── openresponses-http.ts        # Open Responses API
├── config-reload.ts             # 配置热重载
├── device-auth.ts               # 设备认证
├── protocol/                    # 协议定义
│   ├── index.ts                 # 协议入口
│   ├── schema.ts                # Schema 定义
│   └── schema/                  # 各类 Schema
└── server-methods/              # RPC 方法实现
    ├── agent.ts                 # Agent 方法
    ├── chat.ts                  # 聊天方法
    ├── channels.ts              # 渠道方法
    ├── config.ts                # 配置方法
    ├── sessions.ts              # 会话方法
    └── ...
```

## 配置参考

```yaml
# moltbot.yaml

gateway:
  # 绑定地址
  bind: loopback  # loopback | all | <ip>

  # 端口
  port: 18789

  # 认证
  auth:
    token: "your-token"
    password: "your-password"

  # TLS
  tls:
    enabled: true
    cert: /path/to/cert.pem
    key: /path/to/key.pem

  # 设备授权
  devices:
    autoApprove: false
    approved:
      - deviceId: "..."
        name: "My Mac"
```

## 相关文档

- [路由系统](../路由系统/README.md)
- [渠道系统](../渠道系统/README.md)
- [配置系统](../配置系统/README.md)
