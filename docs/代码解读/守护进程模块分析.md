# 守护进程模块分析

## 概述

Moltbot 的守护进程模块采用**跨平台抽象层**设计，通过统一的接口封装不同操作系统的进程管理机制：

- **macOS**: LaunchAgent (launchd)
- **Linux**: systemd 用户服务
- **Windows**: 计划任务 (Scheduled Tasks)

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           守护进程架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        统一服务接口                                  │   │
│  │                      GatewayService                                 │   │
│  │  - install()    安装服务                                            │   │
│  │  - uninstall()  卸载服务                                            │   │
│  │  - stop()       停止服务                                            │   │
│  │  - restart()    重启服务                                            │   │
│  │  - isLoaded()   检查加载状态                                        │   │
│  │  - readRuntime() 读取运行时状态                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│          ┌─────────────────────────┼─────────────────────────┐             │
│          │                         │                         │             │
│          ▼                         ▼                         ▼             │
│  ┌──────────────┐         ┌──────────────┐         ┌──────────────┐       │
│  │    macOS     │         │    Linux     │         │   Windows    │       │
│  │  LaunchAgent │         │   systemd    │         │  Scheduled   │       │
│  │  (launchd)   │         │ User Service │         │    Tasks     │       │
│  └──────────────┘         └──────────────┘         └──────────────┘       │
│         │                         │                         │             │
│         ▼                         ▼                         ▼             │
│  ┌──────────────┐         ┌──────────────┐         ┌──────────────┐       │
│  │ ~/Library/   │         │ ~/.config/   │         │ Task         │       │
│  │ LaunchAgents/│         │ systemd/user/│         │ Scheduler    │       │
│  │ *.plist      │         │ *.service    │         │ *.cmd        │       │
│  └──────────────┘         └──────────────┘         └──────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 模块文件结构

```
src/daemon/
├── service.ts                    # 统一服务抽象层（核心入口）
├── service-runtime.ts            # 服务运行时状态类型定义
├── constants.ts                  # 服务标识符和命名规范
├── program-args.ts               # 程序参数解析和构建
│
├── launchd.ts                    # macOS LaunchAgent 实现
├── launchd-plist.ts              # plist 文件生成和解析
│
├── systemd.ts                    # Linux systemd 实现
├── systemd-unit.ts               # systemd unit 文件生成
├── systemd-linger.ts             # systemd 用户会话持久化
├── systemd-hints.ts              # systemd 故障排查提示
│
├── schtasks.ts                   # Windows 计划任务实现
│
├── service-audit.ts              # 服务配置审计
├── service-env.ts                # 服务环境变量管理
├── diagnostics.ts                # 诊断和日志分析
├── paths.ts                      # 路径解析
├── runtime-paths.ts              # 运行时路径检测
└── runtime-parse.ts              # 运行时输出解析
```

## 核心类型定义

### 服务运行时状态

**文件位置**: `src/daemon/service-runtime.ts:1-13`

```typescript
export type GatewayServiceRuntime = {
  status?: "running" | "stopped" | "unknown";  // 服务状态
  state?: string;                               // 平台特定状态
  subState?: string;                            // 子状态（systemd）
  pid?: number;                                 // 进程ID
  lastExitStatus?: number;                      // 最后退出码
  lastExitReason?: string;                      // 退出原因
  lastRunResult?: string;                       // 最后运行结果（Windows）
  lastRunTime?: string;                         // 最后运行时间（Windows）
  detail?: string;                              // 详细信息
  cachedLabel?: boolean;                        // 是否为缓存标签（macOS）
  missingUnit?: boolean;                        // 服务单元是否缺失
};
```

### 统一服务接口

**文件位置**: `src/daemon/service.ts:39-64`

```typescript
export type GatewayService = {
  label: string;                    // 服务类型标签
  loadedText: string;               // 已加载状态文本
  notLoadedText: string;            // 未加载状态文本

  // 生命周期操作
  install: (args: GatewayServiceInstallArgs) => Promise<void>;
  uninstall: (args: {...}) => Promise<void>;
  stop: (args: {...}) => Promise<void>;
  restart: (args: {...}) => Promise<void>;

  // 状态查询
  isLoaded: (args: {...}) => Promise<boolean>;
  readCommand: (env: Record<string, string | undefined>) => Promise<{...} | null>;
  readRuntime: (env: Record<string, string | undefined>) => Promise<GatewayServiceRuntime>;
};
```

## 进程生命周期管理

### 生命周期流程图

```
安装阶段 (Install)
        ↓
1. 解析程序参数 (program-args.ts)
   ├─ 检测运行时 (Node/Bun)
   ├─ 解析 CLI 入口路径
   └─ 构建启动命令
        ↓
2. 生成服务配置
   ├─ macOS: 生成 plist 文件
   ├─ Linux: 生成 systemd unit 文件
   └─ Windows: 生成 .cmd 脚本
        ↓
3. 注册服务
   ├─ macOS: launchctl bootstrap + enable
   ├─ Linux: systemctl --user enable
   └─ Windows: schtasks /create
        ↓
运行阶段 (Running)
        ↓
4. 启动服务
   ├─ macOS: launchctl kickstart
   ├─ Linux: systemctl --user start
   └─ Windows: schtasks /run
        ↓
5. 监控状态
   ├─ 定期检查进程状态
   ├─ 收集日志输出
   └─ 处理崩溃重启
        ↓
停止阶段 (Stop)
        ↓
6. 停止服务
   ├─ macOS: launchctl kill SIGTERM
   ├─ Linux: systemctl --user stop
   └─ Windows: schtasks /end
        ↓
卸载阶段 (Uninstall)
        ↓
7. 注销服务
   ├─ macOS: launchctl bootout
   ├─ Linux: systemctl --user disable
   └─ Windows: schtasks /delete
        ↓
8. 清理配置文件
```

## 平台特定实现

### macOS LaunchAgent

**文件位置**: `src/daemon/launchd.ts`

```typescript
// plist 文件位置
~/Library/LaunchAgents/bot.molt.gateway.plist

// 关键命令
launchctl bootstrap gui/<uid> <plist-path>  // 注册
launchctl enable gui/<uid>/<label>          // 启用
launchctl kickstart -k gui/<uid>/<label>    // 启动
launchctl kill SIGTERM gui/<uid>/<label>    // 停止
launchctl bootout gui/<uid>/<label>         // 卸载
```

### Linux systemd

**文件位置**: `src/daemon/systemd.ts`

```typescript
// unit 文件位置
~/.config/systemd/user/moltbot-gateway.service

// 关键命令
systemctl --user daemon-reload              // 重载配置
systemctl --user enable moltbot-gateway     // 启用
systemctl --user start moltbot-gateway      // 启动
systemctl --user stop moltbot-gateway       // 停止
systemctl --user disable moltbot-gateway    // 禁用
```

### Windows 计划任务

**文件位置**: `src/daemon/schtasks.ts`

```typescript
// 任务名称
MoltbotGateway

// 关键命令
schtasks /create /tn "MoltbotGateway" /tr <cmd> /sc onlogon
schtasks /run /tn "MoltbotGateway"
schtasks /end /tn "MoltbotGateway"
schtasks /delete /tn "MoltbotGateway" /f
```

## 信号处理机制

### 支持的信号

| 信号 | macOS | Linux | Windows | 用途 |
|------|-------|-------|---------|------|
| SIGTERM | ✅ | ✅ | ✅ | 优雅关闭 |
| SIGINT | ✅ | ✅ | ✅ | 中断 |
| SIGHUP | ✅ | ✅ | ❌ | 重载配置 |
| SIGQUIT | ✅ | ✅ | ❌ | 退出并转储 |
| SIGBREAK | ❌ | ❌ | ✅ | Windows 中断 |

### 信号处理流程

```typescript
// 注册信号处理器
process.on('SIGTERM', async () => {
  log.info('Received SIGTERM, shutting down gracefully...');
  await gateway.stop();
  process.exit(0);
});

process.on('SIGHUP', async () => {
  log.info('Received SIGHUP, reloading configuration...');
  await gateway.reload();
});
```

## 日志和监控

### 日志位置

| 平台 | 日志位置 |
|------|---------|
| macOS | `~/Library/Logs/Moltbot/gateway.log` |
| Linux | `journalctl --user -u moltbot-gateway` |
| Windows | `%LOCALAPPDATA%\Moltbot\Logs\gateway.log` |

### 诊断命令

```bash
# macOS
launchctl print gui/<uid>/bot.molt.gateway

# Linux
systemctl --user status moltbot-gateway
journalctl --user -u moltbot-gateway -f

# Windows
schtasks /query /tn "MoltbotGateway" /v
```

## 与 Gateway 的关系

```
守护进程模块
      │
      ├── 启动 Gateway 进程
      │     └── moltbot gateway run --bind loopback --port 18789
      │
      ├── 监控 Gateway 状态
      │     ├── 检查进程存活
      │     ├── 收集资源使用
      │     └── 处理崩溃重启
      │
      └── 管理 Gateway 生命周期
            ├── 开机自启动
            ├── 配置热重载
            └── 优雅关闭
```

## 核心代码位置

```
src/daemon/
├── service.ts:39-64           # 统一服务接口
├── service-runtime.ts:1-13    # 运行时状态类型
├── launchd.ts:50-200          # macOS 实现
├── launchd-plist.ts:20-100    # plist 生成
├── systemd.ts:50-200          # Linux 实现
├── systemd-unit.ts:20-80      # unit 文件生成
├── schtasks.ts:30-150         # Windows 实现
├── program-args.ts:20-100     # 参数解析
├── diagnostics.ts:30-120      # 诊断工具
```

## 相关文档

- [Gateway 网关模块](./Gateway网关模块分析.md)
- [基础设施模块](./基础设施模块分析.md)
- [配置系统](./配置系统分析.md)
