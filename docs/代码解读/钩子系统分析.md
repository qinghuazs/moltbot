# é’©å­ç³»ç»Ÿæ·±åº¦åˆ†æ

## 1. é’©å­ç³»ç»Ÿçš„æ¶æ„è®¾è®¡

### 1.1 æ ¸å¿ƒæ¶æ„

Moltbot çš„é’©å­ç³»ç»Ÿæ˜¯ä¸€ä¸ª**äº‹ä»¶é©±åŠ¨çš„å¯æ‰©å±•æ¶æ„**ï¼Œä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ç»„æˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‹ä»¶è§¦å‘å±‚                              â”‚
â”‚  (commands-core.ts, commands-session.ts, bootstrap.ts)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ triggerInternalHook()
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é’©å­æ³¨å†Œä¸åˆ†å‘å±‚                          â”‚
â”‚              (internal-hooks.ts)                        â”‚
â”‚  - äº‹ä»¶æ³¨å†Œè¡¨ (Map<eventKey, handlers[]>)                â”‚
â”‚  - äº‹ä»¶åˆ†å‘é€»è¾‘                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ è°ƒç”¨å·²æ³¨å†Œçš„å¤„ç†å™¨
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é’©å­åŠ è½½ä¸å‘ç°å±‚                          â”‚
â”‚              (loader.ts, workspace.ts)                  â”‚
â”‚  - ç›®å½•æ‰«æä¸é’©å­å‘ç°                                      â”‚
â”‚  - å…ƒæ•°æ®è§£æ (HOOK.md frontmatter)                      â”‚
â”‚  - åŠ¨æ€æ¨¡å—åŠ è½½                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é’©å­å®ç°å±‚                               â”‚
â”‚  - å†…ç½®é’©å­ (bundled/)                                    â”‚
â”‚  - æ‰˜ç®¡é’©å­ (~/.clawdbot/hooks/)                         â”‚
â”‚  - å·¥ä½œåŒºé’©å­ (<workspace>/hooks/)                        â”‚
â”‚  - æ’ä»¶é’©å­ (plugin-hooks.ts)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å…³é”®æ–‡ä»¶ä¸èŒè´£

| æ–‡ä»¶è·¯å¾„ | æ ¸å¿ƒèŒè´£ |
|---------|---------|
| `src/hooks/internal-hooks.ts` | é’©å­æ³¨å†Œè¡¨ã€äº‹ä»¶åˆ†å‘å¼•æ“ |
| `src/hooks/loader.ts` | é’©å­åŠ¨æ€åŠ è½½å™¨ |
| `src/hooks/workspace.ts` | é’©å­å‘ç°ä¸ç›®å½•æ‰«æ |
| `src/hooks/types.ts` | ç±»å‹å®šä¹‰ |
| `src/hooks/config.ts` | é…ç½®è§£æä¸èµ„æ ¼æ£€æŸ¥ |
| `src/hooks/frontmatter.ts` | HOOK.md å…ƒæ•°æ®è§£æ |
| `src/hooks/hooks-status.ts` | é’©å­çŠ¶æ€æŠ¥å‘Šç”Ÿæˆ |
| `src/hooks/plugin-hooks.ts` | æ’ä»¶é’©å­é›†æˆ |

## 2. é’©å­çš„ç±»å‹å’Œè§¦å‘æ—¶æœº

### 2.1 äº‹ä»¶ç±»å‹å®šä¹‰

**æ ¸å¿ƒç±»å‹** (`src/hooks/internal-hooks.ts`):

```typescript
export type InternalHookEventType = "command" | "session" | "agent" | "gateway";

export interface InternalHookEvent {
  type: InternalHookEventType;      // äº‹ä»¶å¤§ç±»
  action: string;                   // å…·ä½“åŠ¨ä½œ
  sessionKey: string;               // ä¼šè¯æ ‡è¯†
  context: Record<string, unknown>; // ä¸Šä¸‹æ–‡æ•°æ®
  timestamp: Date;                  // æ—¶é—´æˆ³
  messages: string[];               // è¿”å›ç»™ç”¨æˆ·çš„æ¶ˆæ¯
}
```

### 2.2 å·²å®ç°çš„äº‹ä»¶è§¦å‘ç‚¹

#### 2.2.1 å‘½ä»¤äº‹ä»¶ (command)

**è§¦å‘ä½ç½®**: `src/auto-reply/reply/commands-core.ts`

```typescript
// /new æˆ– /reset å‘½ä»¤è§¦å‘
if (resetRequested && params.command.isAuthorizedSender) {
  const commandAction = resetMatch?.[1] ?? "new";
  const hookEvent = createInternalHookEvent("command", commandAction, params.sessionKey ?? "", {
    sessionEntry: params.sessionEntry,
    previousSessionEntry: params.previousSessionEntry,
    commandSource: params.command.surface,
    senderId: params.command.senderId,
    cfg: params.cfg,
  });
  await triggerInternalHook(hookEvent);
}
```

**æ”¯æŒçš„å‘½ä»¤åŠ¨ä½œ**:
- `command:new` - æ–°å»ºä¼šè¯
- `command:reset` - é‡ç½®ä¼šè¯
- `command:stop` - åœæ­¢ä¼šè¯

#### 2.2.2 Agent ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ (agent)

**è§¦å‘ä½ç½®**: `src/agents/bootstrap-hooks.ts`

```typescript
// Agent å¯åŠ¨æ—¶çš„ bootstrap é’©å­
const event = createInternalHookEvent("agent", "bootstrap", sessionKey, context);
await triggerInternalHook(event);
```

**ä¸Šä¸‹æ–‡æ•°æ®**:
```typescript
const context: AgentBootstrapHookContext = {
  workspaceDir: params.workspaceDir,
  bootstrapFiles: params.files,  // å¯è¢«é’©å­ä¿®æ”¹
  cfg: params.config,
  sessionKey: params.sessionKey,
  sessionId: params.sessionId,
  agentId,
};
```

#### 2.2.3 Gateway å¯åŠ¨äº‹ä»¶ (gateway)

**è§¦å‘ä½ç½®**: `src/gateway/server-startup.ts`

```typescript
// Gateway å¯åŠ¨åå»¶è¿Ÿè§¦å‘
setTimeout(() => {
  const hookEvent = createInternalHookEvent("gateway", "startup", "", {
    cfg: params.cfg,
    workspaceDir: params.defaultWorkspaceDir,
    deps: params.deps,
  });
  void triggerInternalHook(hookEvent);
}, 250);
```

### 2.3 äº‹ä»¶è§¦å‘æ—¶åºå›¾

```
ç”¨æˆ·å‘é€ /new å‘½ä»¤
    â†“
handleCommands() æ£€æµ‹åˆ° reset å‘½ä»¤
    â†“
åˆ›å»º command:new äº‹ä»¶
    â†“
triggerInternalHook(event)
    â†“
æŸ¥æ‰¾æ³¨å†Œçš„å¤„ç†å™¨:
  - handlers.get("command")      // é€šç”¨å‘½ä»¤å¤„ç†å™¨
  - handlers.get("command:new")  // ç‰¹å®šå‘½ä»¤å¤„ç†å™¨
    â†“
æŒ‰æ³¨å†Œé¡ºåºä¾æ¬¡è°ƒç”¨å¤„ç†å™¨
    â†“
å¤„ç†å™¨å¯ä»¥:
  - è¯»å– event.context è·å–ä¸Šä¸‹æ–‡
  - ä¿®æ”¹ event.context (å¦‚ bootstrap é’©å­)
  - å‘ event.messages æ¨é€æ¶ˆæ¯
    â†“
è¿”å›ç»™ç”¨æˆ· (å¦‚æœæœ‰æ¶ˆæ¯)
```

## 3. é’©å­çš„æ³¨å†Œå’Œæ‰§è¡Œæœºåˆ¶

### 3.1 æ³¨å†Œæœºåˆ¶

**æ ¸å¿ƒæ³¨å†Œå‡½æ•°** (`internal-hooks.ts`):

```typescript
const handlers = new Map<string, InternalHookHandler[]>();

export function registerInternalHook(eventKey: string, handler: InternalHookHandler): void {
  if (!handlers.has(eventKey)) {
    handlers.set(eventKey, []);
  }
  handlers.get(eventKey)!.push(handler);
}
```

**æ³¨å†Œç­–ç•¥**:
1. **å¤šå¤„ç†å™¨æ”¯æŒ**: åŒä¸€äº‹ä»¶å¯æ³¨å†Œå¤šä¸ªå¤„ç†å™¨
2. **é¡ºåºæ‰§è¡Œ**: æŒ‰æ³¨å†Œé¡ºåºä¾æ¬¡è°ƒç”¨
3. **é”™è¯¯éš”ç¦»**: å•ä¸ªå¤„ç†å™¨å¤±è´¥ä¸å½±å“å…¶ä»–å¤„ç†å™¨

### 3.2 æ‰§è¡Œæœºåˆ¶

**åˆ†å‘é€»è¾‘** (`internal-hooks.ts`):

```typescript
export async function triggerInternalHook(event: InternalHookEvent): Promise<void> {
  // 1. è·å–é€šç”¨ç±»å‹å¤„ç†å™¨ (å¦‚ "command")
  const typeHandlers = handlers.get(event.type) ?? [];

  // 2. è·å–ç‰¹å®šåŠ¨ä½œå¤„ç†å™¨ (å¦‚ "command:new")
  const specificHandlers = handlers.get(`${event.type}:${event.action}`) ?? [];

  // 3. åˆå¹¶å¤„ç†å™¨åˆ—è¡¨
  const allHandlers = [...typeHandlers, ...specificHandlers];

  // 4. ä¾æ¬¡æ‰§è¡Œï¼Œæ•è·é”™è¯¯
  for (const handler of allHandlers) {
    try {
      await handler(event);
    } catch (err) {
      console.error(`Hook error [${event.type}:${event.action}]:`,
                    err instanceof Error ? err.message : String(err));
    }
  }
}
```

**å…³é”®ç‰¹æ€§**:
- **åŒå±‚åŒ¹é…**: å…ˆåŒ¹é…ç±»å‹ï¼Œå†åŒ¹é…å…·ä½“åŠ¨ä½œ
- **å¼‚æ­¥æ”¯æŒ**: ä½¿ç”¨ `await` ç¡®ä¿å¤„ç†å™¨æŒ‰åºå®Œæˆ
- **å®¹é”™è®¾è®¡**: é”™è¯¯è¢«æ•è·å¹¶è®°å½•ï¼Œä¸ä¸­æ–­åç»­å¤„ç†å™¨

### 3.3 åŠ è½½æµç¨‹

**ä¸»åŠ è½½å‡½æ•°** (`loader.ts`):

```typescript
export async function loadInternalHooks(cfg: MoltbotConfig, workspaceDir: string): Promise<number> {
  // 1. æ£€æŸ¥é’©å­æ˜¯å¦å¯ç”¨
  if (!cfg.hooks?.internal?.enabled) return 0;

  let loadedCount = 0;

  // 2. ä»ç›®å½•åŠ è½½é’©å­ (æ–°ç³»ç»Ÿ)
  const hookEntries = loadWorkspaceHookEntries(workspaceDir, { config: cfg });
  const eligible = hookEntries.filter((entry) => shouldIncludeHook({ entry, config: cfg }));

  for (const entry of eligible) {
    // 3. æ£€æŸ¥é…ç½®æ˜¯å¦ç¦ç”¨
    const hookConfig = resolveHookConfig(cfg, entry.hook.name);
    if (hookConfig?.enabled === false) continue;

    // 4. åŠ¨æ€å¯¼å…¥å¤„ç†å™¨æ¨¡å— (å¸¦ç¼“å­˜ç ´å)
    const url = pathToFileURL(entry.hook.handlerPath).href;
    const cacheBustedUrl = `${url}?t=${Date.now()}`;
    const mod = await import(cacheBustedUrl);

    // 5. è·å–å¯¼å‡ºçš„å¤„ç†å™¨å‡½æ•°
    const exportName = entry.metadata?.export ?? "default";
    const handler = mod[exportName];

    // 6. ä¸ºæ¯ä¸ªäº‹ä»¶æ³¨å†Œå¤„ç†å™¨
    const events = entry.metadata?.events ?? [];
    for (const event of events) {
      registerInternalHook(event, handler as InternalHookHandler);
    }

    loadedCount++;
  }

  return loadedCount;
}
```

**åŠ è½½æ—¶æœº**: Gateway å¯åŠ¨æ—¶

## 4. é’©å­å‘ç°ä¸ä¼˜å…ˆçº§

### 4.1 å‘ç°è·¯å¾„

**æ‰«æé¡ºåº** (`workspace.ts`):

```typescript
function loadHookEntries(workspaceDir: string, opts?: {...}): HookEntry[] {
  const bundledHooksDir = resolveBundledHooksDir();
  const managedHooksDir = path.join(CONFIG_DIR, "hooks");
  const workspaceHooksDir = path.join(workspaceDir, "hooks");
  const extraDirs = opts?.config?.hooks?.internal?.load?.extraDirs ?? [];

  // åŠ è½½é¡ºåº
  const bundledHooks = loadHooksFromDir({ dir: bundledHooksDir, source: "moltbot-bundled" });
  const extraHooks = extraDirs.flatMap(...);
  const managedHooks = loadHooksFromDir({ dir: managedHooksDir, source: "moltbot-managed" });
  const workspaceHooks = loadHooksFromDir({ dir: workspaceHooksDir, source: "moltbot-workspace" });

  // ä¼˜å…ˆçº§: extra < bundled < managed < workspace (workspace æœ€é«˜)
  const merged = new Map<string, Hook>();
  for (const hook of extraHooks) merged.set(hook.name, hook);
  for (const hook of bundledHooks) merged.set(hook.name, hook);
  for (const hook of managedHooks) merged.set(hook.name, hook);
  for (const hook of workspaceHooks) merged.set(hook.name, hook);

  return Array.from(merged.values()).map(...);
}
```

**ç›®å½•æ˜ å°„**:
- **Bundled**: `<moltbot>/dist/hooks/bundled/`
- **Managed**: `~/.clawdbot/hooks/`
- **Workspace**: `<workspace>/hooks/`
- **Plugin**: ç”±æ’ä»¶ç³»ç»Ÿç®¡ç†

### 4.2 é’©å­ç»“æ„

æ¯ä¸ªé’©å­ç›®å½•å¿…é¡»åŒ…å«:

```
my-hook/
â”œâ”€â”€ HOOK.md          # å…ƒæ•°æ® + æ–‡æ¡£
â””â”€â”€ handler.ts       # å¤„ç†å™¨å®ç° (æˆ– handler.js/index.ts/index.js)
```

**HOOK.md æ ¼å¼**:

```yaml
---
name: session-memory
description: "Save session context to memory when /new command is issued"
homepage: https://docs.molt.bot/hooks#session-memory
metadata:
  {
    "moltbot": {
      "emoji": "ğŸ’¾",
      "events": ["command:new"],
      "requires": { "config": ["workspace.dir"] },
      "install": [{ "id": "bundled", "kind": "bundled", "label": "Bundled with Moltbot" }]
    }
  }
---
```

### 4.3 èµ„æ ¼æ£€æŸ¥

**æ£€æŸ¥é€»è¾‘** (`config.ts`):

```typescript
export function shouldIncludeHook(params: {
  entry: HookEntry;
  config?: MoltbotConfig;
  eligibility?: HookEligibilityContext;
}): boolean {
  // 1. æ£€æŸ¥æ˜¯å¦è¢«æ˜¾å¼ç¦ç”¨
  if (hookConfig?.enabled === false) return false;

  // 2. æ£€æŸ¥æ“ä½œç³»ç»Ÿè¦æ±‚
  if (osList.length > 0 && !osList.includes(resolveRuntimePlatform())) return false;

  // 3. å¦‚æœæ ‡è®°ä¸º 'always'ï¼Œè·³è¿‡å…¶ä»–æ£€æŸ¥
  if (entry.metadata?.always === true) return true;

  // 4. æ£€æŸ¥å¿…éœ€çš„äºŒè¿›åˆ¶æ–‡ä»¶ (å…¨éƒ¨å¿…é¡»å­˜åœ¨)
  for (const bin of requiredBins) {
    if (!hasBinary(bin)) return false;
  }

  // 5. æ£€æŸ¥ anyBins (è‡³å°‘ä¸€ä¸ªå­˜åœ¨)
  if (requiredAnyBins.length > 0) {
    const anyFound = requiredAnyBins.some((bin) => hasBinary(bin));
    if (!anyFound) return false;
  }

  // 6. æ£€æŸ¥ç¯å¢ƒå˜é‡
  for (const envName of requiredEnv) {
    if (!process.env[envName] && !hookConfig?.env?.[envName]) return false;
  }

  // 7. æ£€æŸ¥é…ç½®è·¯å¾„
  for (const configPath of requiredConfig) {
    if (!isConfigPathTruthy(config, configPath)) return false;
  }

  return true;
}
```

## 5. å†…ç½®é’©å­å®ç°åˆ†æ

### 5.1 session-memory é’©å­

**åŠŸèƒ½**: åœ¨ `/new` å‘½ä»¤æ—¶ä¿å­˜ä¼šè¯ä¸Šä¸‹æ–‡åˆ°è®°å¿†æ–‡ä»¶

**å…³é”®å®ç°** (`bundled/session-memory/handler.ts`):

```typescript
const saveSessionToMemory: HookHandler = async (event) => {
  // 1. åªå“åº” /new å‘½ä»¤
  if (event.type !== "command" || event.action !== "new") return;

  // 2. ä»ä¸Šä¸‹æ–‡è·å–ä¼šè¯ä¿¡æ¯
  const sessionEntry = context.previousSessionEntry || context.sessionEntry;
  const sessionFile = sessionEntry.sessionFile;

  // 3. è¯»å–æœ€è¿‘çš„ä¼šè¯æ¶ˆæ¯ (é»˜è®¤ 15 æ¡)
  const sessionContent = await getRecentSessionContent(sessionFile, messageCount);

  // 4. ä½¿ç”¨ LLM ç”Ÿæˆæè¿°æ€§æ–‡ä»¶å slug
  const slug = await generateSlugViaLLM({ sessionContent, cfg });

  // 5. åˆ›å»ºè®°å¿†æ–‡ä»¶
  const filename = `${dateStr}-${slug}.md`;
  const memoryFilePath = path.join(memoryDir, filename);
  await fs.writeFile(memoryFilePath, entry, "utf-8");
};
```

### 5.2 soul-evil é’©å­

**åŠŸèƒ½**: åœ¨ç‰¹å®šæ—¶é—´çª—å£æˆ–éšæœºæƒ…å†µä¸‹æ›¿æ¢ SOUL.md å†…å®¹

**å…³é”®å®ç°** (`bundled/soul-evil/handler.ts`):

```typescript
const soulEvilHook: HookHandler = async (event) => {
  // 1. åªå“åº” agent:bootstrap äº‹ä»¶
  if (!isAgentBootstrapEvent(event)) return;

  // 2. è·³è¿‡å­ agent
  if (context.sessionKey && isSubagentSessionKey(context.sessionKey)) return;

  // 3. æ£€æŸ¥é’©å­é…ç½®
  const hookConfig = resolveHookConfig(cfg, HOOK_KEY);
  const soulConfig = resolveSoulEvilConfigFromHook(hookConfig);

  // 4. åº”ç”¨ SOUL æ›¿æ¢é€»è¾‘
  const updated = await applySoulEvilOverride({
    files: context.bootstrapFiles,
    workspaceDir,
    config: soulConfig,
  });

  // 5. ä¿®æ”¹ä¸Šä¸‹æ–‡ä¸­çš„ bootstrap æ–‡ä»¶åˆ—è¡¨
  context.bootstrapFiles = updated;
};
```

### 5.3 boot-md é’©å­

**åŠŸèƒ½**: Gateway å¯åŠ¨æ—¶è¿è¡Œ BOOT.md

**å®ç°** (`bundled/boot-md/handler.ts`):

```typescript
const runBootChecklist: HookHandler = async (event) => {
  // 1. åªå“åº” gateway:startup äº‹ä»¶
  if (event.type !== "gateway" || event.action !== "startup") return;

  // 2. è·å–é…ç½®å’Œå·¥ä½œåŒº
  const context = event.context as BootHookContext;
  if (!context.cfg || !context.workspaceDir) return;

  // 3. è¿è¡Œ BOOT.md (å¦‚æœå­˜åœ¨)
  const deps = context.deps ?? createDefaultDeps();
  await runBootOnce({ cfg: context.cfg, deps, workspaceDir: context.workspaceDir });
};
```

### 5.4 command-logger é’©å­

**åŠŸèƒ½**: è®°å½•æ‰€æœ‰å‘½ä»¤åˆ°å®¡è®¡æ—¥å¿—

**å®ç°** (`bundled/command-logger/handler.ts`):

```typescript
const logCommand: HookHandler = async (event) => {
  // 1. åªå¤„ç†å‘½ä»¤äº‹ä»¶
  if (event.type !== "command") return;

  // 2. åˆ›å»ºæ—¥å¿—ç›®å½•
  const logDir = path.join(os.homedir(), ".clawdbot", "logs");
  await fs.mkdir(logDir, { recursive: true });

  // 3. è¿½åŠ æ—¥å¿—æ¡ç›®
  const logFile = path.join(logDir, "commands.log");
  const logLine = JSON.stringify({
    timestamp: event.timestamp.toISOString(),
    action: event.action,
    sessionKey: event.sessionKey,
    senderId: event.context.senderId ?? "unknown",
    source: event.context.commandSource ?? "unknown",
  }) + "\n";

  await fs.appendFile(logFile, logLine, "utf-8");
};
```

## 6. è‡ªå®šä¹‰é’©å­çš„å¼€å‘æ–¹å¼

### 6.1 åŸºæœ¬ç»“æ„

**1. åˆ›å»ºé’©å­ç›®å½•**:

```bash
mkdir -p ~/clawd/hooks/my-custom-hook
cd ~/clawd/hooks/my-custom-hook
```

**2. åˆ›å»º HOOK.md**:

```markdown
---
name: my-custom-hook
description: "My custom hook description"
homepage: https://example.com/docs
metadata:
  {
    "moltbot": {
      "emoji": "ğŸ¯",
      "events": ["command:new", "command:stop"],
      "requires": {
        "bins": ["git"],
        "env": ["MY_API_KEY"],
        "config": ["workspace.dir"]
      }
    }
  }
---

# My Custom Hook

Detailed documentation here...
```

**3. åˆ›å»º handler.ts**:

```typescript
import type { HookHandler } from 'moltbot/hooks';

const myCustomHook: HookHandler = async (event) => {
  // 1. è¿‡æ»¤äº‹ä»¶ç±»å‹
  if (event.type !== 'command') return;

  // 2. è®¿é—®ä¸Šä¸‹æ–‡æ•°æ®
  const sessionKey = event.sessionKey;
  const cfg = event.context.cfg;

  // 3. æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
  console.log(`[my-custom-hook] Processing ${event.action} command`);

  // 4. å¯é€‰: å‘ç”¨æˆ·å‘é€æ¶ˆæ¯
  event.messages.push('Custom hook executed!');

  // 5. å¯é€‰: ä¿®æ”¹ä¸Šä¸‹æ–‡ (ä»… bootstrap é’©å­)
  if (event.type === 'agent' && event.action === 'bootstrap') {
    // event.context.bootstrapFiles = modifiedFiles;
  }
};

export default myCustomHook;
```

### 6.2 å…ƒæ•°æ®å­—æ®µè¯¦è§£

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `events` | `string[]` | ç›‘å¬çš„äº‹ä»¶åˆ—è¡¨ (å¿…éœ€) |
| `emoji` | `string` | CLI æ˜¾ç¤ºçš„ emoji |
| `export` | `string` | å¯¼å‡ºåç§° (é»˜è®¤ "default") |
| `always` | `boolean` | è·³è¿‡èµ„æ ¼æ£€æŸ¥ |
| `requires.bins` | `string[]` | å¿…éœ€çš„äºŒè¿›åˆ¶æ–‡ä»¶ (å…¨éƒ¨) |
| `requires.anyBins` | `string[]` | å¿…éœ€çš„äºŒè¿›åˆ¶æ–‡ä»¶ (è‡³å°‘ä¸€ä¸ª) |
| `requires.env` | `string[]` | å¿…éœ€çš„ç¯å¢ƒå˜é‡ |
| `requires.config` | `string[]` | å¿…éœ€çš„é…ç½®è·¯å¾„ |
| `os` | `string[]` | æ”¯æŒçš„æ“ä½œç³»ç»Ÿ |

### 6.3 äº‹ä»¶ç±»å‹å‚è€ƒ

| äº‹ä»¶é”® | è§¦å‘æ—¶æœº | ä¸Šä¸‹æ–‡æ•°æ® |
|-------|---------|-----------|
| `command` | æ‰€æœ‰å‘½ä»¤ | `senderId`, `commandSource` |
| `command:new` | `/new` å‘½ä»¤ | `sessionEntry`, `previousSessionEntry`, `cfg` |
| `command:reset` | `/reset` å‘½ä»¤ | åŒä¸Š |
| `command:stop` | `/stop` å‘½ä»¤ | `sessionEntry` |
| `agent:bootstrap` | Agent å¯åŠ¨ | `workspaceDir`, `bootstrapFiles`, `cfg`, `sessionKey` |
| `gateway:startup` | Gateway å¯åŠ¨ | `cfg`, `workspaceDir`, `deps` |

## 7. CLI å‘½ä»¤å‚è€ƒ

### 7.1 é’©å­ç®¡ç†å‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ |
|-----|------|
| `moltbot hooks list` | åˆ—å‡ºæ‰€æœ‰é’©å­ |
| `moltbot hooks info <name>` | æ˜¾ç¤ºé’©å­è¯¦æƒ… |
| `moltbot hooks check` | æ£€æŸ¥é’©å­çŠ¶æ€ |
| `moltbot hooks enable <name>` | å¯ç”¨é’©å­ |
| `moltbot hooks disable <name>` | ç¦ç”¨é’©å­ |
| `moltbot hooks install <path>` | å®‰è£…é’©å­ |

## 8. å…³é”®æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/hooks/internal-hooks.ts` | é’©å­æ³¨å†Œè¡¨ã€äº‹ä»¶åˆ†å‘å¼•æ“ |
| `src/hooks/loader.ts` | é’©å­åŠ¨æ€åŠ è½½å™¨ |
| `src/hooks/workspace.ts` | é’©å­å‘ç°ä¸ç›®å½•æ‰«æ |
| `src/hooks/types.ts` | ç±»å‹å®šä¹‰ |
| `src/hooks/config.ts` | é…ç½®è§£æä¸èµ„æ ¼æ£€æŸ¥ |
| `src/hooks/frontmatter.ts` | HOOK.md å…ƒæ•°æ®è§£æ |
| `src/hooks/hooks-status.ts` | é’©å­çŠ¶æ€æŠ¥å‘Šç”Ÿæˆ |
| `src/hooks/plugin-hooks.ts` | æ’ä»¶é’©å­é›†æˆ |
| `src/cli/hooks-cli.ts` | CLI å‘½ä»¤å®ç° |
