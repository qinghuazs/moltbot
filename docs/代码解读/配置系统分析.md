# 配置系统深度分析

## 1. 配置系统架构概览

Moltbot 的配置系统是一个功能完整、设计精良的配置管理框架，包含以下核心能力：

- **配置文件加载与解析** (JSON5 格式)
- **类型安全验证** (基于 Zod schema)
- **环境变量替换与注入**
- **配置文件包含机制** ($include 指令)
- **默认值应用与规范化**
- **配置持久化与备份**
- **运行时覆盖机制**

## 2. 配置文件的加载和解析机制

### 2.1 核心入口

**文件：** `src/config/io.ts`

**主要函数：** `createConfigIO(overrides?: ConfigIoDeps)`

创建配置 I/O 操作对象，支持依赖注入，返回三个核心方法：
- `loadConfig`
- `readConfigFileSnapshot`
- `writeConfigFile`

### 2.2 配置加载流程

```typescript
export async function loadConfig() {
  // 1. 检查配置文件是否存在
  if (!deps.fs.existsSync(configPath)) {
    loadShellEnvFallback(...);
    return ;
  }

  // 2. 读取原始文件内容
  const raw = deps.fs.readFileSync(configPath, "utf-8");

  // 3. JSON5 解析
  const parsed = deps.json5.parse(raw);

  // 4. 解析 $include 指令 (支持模块化配置)
  const resolved = resolveConfigIncludes(parsed, configPath, {...});

  // 5. 应用 config.env 到 process.env
  applyConfigEnv(resolved as MoltbotConfig, deps.env);

  // 6. 环境变量替换 (${VAR_NAME} 语法)
  const substituted = resolveConfigEnvVars(resolved, deps.env);

  // 7. 验证配置结构
  const validated = validateConfigObjectWithPlugins(resolvedConfig);

  // 8. 应用默认值
  const cfg = applyModelDefaults(
    applyCompactionDefaults(
      applyContextPruningDefaults(
        applyAgentDefaults(
          applySessionDefaults(
            applyLoggingDefaults(
              applyMessageDefaults(validated.config)
            )
          )
        )
      )
    )
  );

  // 9. 路径规范化 (处理 ~ 开头的路径)
  normalizeConfigPaths(cfg);

  // 10. 应用运行时覆盖
  return applyConfigOverrides(cfg);
}
```

### 2.3 配置缓存机制

```typescript
// 缓存结构
let configCache: {
  configPath: string;
  expiresAt: number;
  config: MoltbotConfig;
} | null = null;

// 默认缓存时间: 200ms
const DEFAULT_CONFIG_CACHE_MS = 200;

// 环境变量控制:
// - CLAWDBOT_CONFIG_CACHE_MS: 设置缓存时间
// - CLAWDBOT_DISABLE_CONFIG_CACHE: 禁用缓存
```

**缓存策略：**
- 同一配置路径在 200ms 内重复读取时直接返回缓存
- 写入配置时自动清除缓存 (`clearConfigCache()`)
- 可通过环境变量调整或禁用

### 2.4 配置路径解析

**文件：** `src/config/paths.ts`

**状态目录解析优先级：**
1. `MOLTBOT_STATE_DIR` 或 `CLAWDBOT_STATE_DIR` 环境变量
2. `~/.moltbot` (如果存在且 `~/.clawdbot` 不存在)
3. `~/.clawdbot` (默认，向后兼容)

**配置文件候选路径：**
1. 显式指定: `MOLTBOT_CONFIG_PATH` / `CLAWDBOT_CONFIG_PATH`
2. `$STATE_DIR/moltbot.json`
3. `$STATE_DIR/clawdbot.json` (legacy)
4. `~/.moltbot/moltbot.json`
5. `~/.clawdbot/moltbot.json`

## 3. 配置的数据结构和类型定义

### 3.1 主类型定义

**文件：** `src/config/types.clawdbot.ts`

```typescript
export type MoltbotConfig = {
  meta?: {
    lastTouchedVersion?: string;  // 最后修改配置的版本
    lastTouchedAt?: string;        // 最后修改时间 (ISO)
  };
  auth?: AuthConfig;               // 认证配置
  env?: {                          // 环境变量配置
    shellEnv?: { enabled?: boolean; timeoutMs?: number };
    vars?: Record<string, string>;
    [key: string]: string | ...;   // 支持直接定义环境变量
  };
  wizard?: {...};                  // 向导配置
  diagnostics?: DiagnosticsConfig; // 诊断配置
  logging?: LoggingConfig;         // 日志配置
  update?: {...};                  // 更新配置
  browser?: BrowserConfig;         // 浏览器配置
  ui?: {...};                      // UI 配置
  skills?: SkillsConfig;           // 技能配置
  plugins?: PluginsConfig;         // 插件配置
  models?: ModelsConfig;           // 模型配置
  nodeHost?: NodeHostConfig;       // 节点主机配置
  agents?: AgentsConfig;           // Agent 配置
  tools?: ToolsConfig;             // 工具配置
  bindings?: AgentBinding[];       // 绑定配置
  broadcast?: BroadcastConfig;     // 广播配置
  audio?: AudioConfig;             // 音频配置
  messages?: MessagesConfig;       // 消息配置
  commands?: CommandsConfig;       // 命令配置
  approvals?: ApprovalsConfig;     // 审批配置
  session?: SessionConfig;         // 会话配置
  web?: WebConfig;                 // Web 配置
  channels?: ChannelsConfig;       // 通道配置
  cron?: CronConfig;               // 定时任务配置
  hooks?: HooksConfig;             // 钩子配置
  discovery?: DiscoveryConfig;     // 发现配置
  canvasHost?: CanvasHostConfig;   // Canvas 主机配置
  talk?: TalkConfig;               // Talk 配置
  gateway?: GatewayConfig;         // 网关配置
};
```

### 3.2 类型模块化组织

配置类型被拆分为多个模块文件：

```
types.agent-defaults.ts  - Agent 默认配置
types.agents.ts          - Agent 配置
types.approvals.ts       - 审批配置
types.auth.ts            - 认证配置
types.base.ts            - 基础类型
types.browser.ts         - 浏览器配置
types.channels.ts        - 通道配置
types.discord.ts         - Discord 配置
types.gateway.ts         - 网关配置
types.models.ts          - 模型配置
types.plugins.ts         - 插件配置
types.tools.ts           - 工具配置
types.telegram.ts        - Telegram 配置
types.whatsapp.ts        - WhatsApp 配置
... (更多)
```

## 4. 配置的验证和默认值

### 4.1 Zod Schema 验证

**文件：** `src/config/zod-schema.ts`

```typescript
export const MoltbotSchema = z.object({
  meta: z.object({
    lastTouchedVersion: z.string().optional(),
    lastTouchedAt: z.string().optional(),
  }).strict().optional(),

  env: z.object({
    shellEnv: z.object({
      enabled: z.boolean().optional(),
      timeoutMs: z.number().int().nonnegative().optional(),
    }).strict().optional(),
    vars: z.record(z.string(), z.string()).optional(),
  }).catchall(z.string()).optional(),

  logging: z.object({
    level: z.union([
      z.literal("silent"),
      z.literal("fatal"),
      z.literal("error"),
      z.literal("warn"),
      z.literal("info"),
      z.literal("debug"),
      z.literal("trace"),
    ]).optional(),
    // ... 更多字段
  }).strict().optional(),

  // ... 更多顶级配置
});
```

**Schema 特点：**
- 使用 `.strict()` 防止未知字段
- 使用 `.optional()` 标记可选字段
- 使用 `z.union()` 定义枚举类型
- 使用 `z.record()` 定义动态键值对

### 4.2 验证流程

**文件：** `src/config/validation.ts`

```typescript
export function validateConfigObjectWithPlugins(raw: unknown):
  | { ok: true; config: MoltbotConfig; warnings: ConfigValidationIssue[] }
  | { ok: false; issues: ConfigValidationIssue[]; warnings: ConfigValidationIssue[] }
{
  // 1. 基础验证 (Zod schema + legacy 检查)
  // 2. 插件验证
  // 3. 检查插件诊断信息
  // 4. 验证插件引用
  // 5. 验证通道配置
  // 6. 验证 heartbeat 目标
  // 7. 验证插件配置 schema
}
```

### 4.3 默认值应用

**文件：** `src/config/defaults.ts`

**默认值应用函数：**

- `applyModelDefaults()` - 模型配置默认值
- `applyAgentDefaults()` - Agent 配置默认值
- `applyContextPruningDefaults()` - 上下文修剪默认值
- `applySessionDefaults()` - 会话配置默认值
- `applyMessageDefaults()` - 消息配置默认值
- `applyLoggingDefaults()` - 日志配置默认值
- `applyCompactionDefaults()` - 压缩配置默认值

## 5. 配置的持久化和更新

### 5.1 配置写入

```typescript
async function writeConfigFile(cfg: MoltbotConfig) {
  // 1. 清除配置缓存
  clearConfigCache();

  // 2. 验证配置
  const validated = validateConfigObjectWithPlugins(cfg);

  // 3. 创建配置目录 (权限: 0o700)
  await deps.fs.promises.mkdir(dir, { recursive: true, mode: 0o700 });

  // 4. 添加版本戳
  const json = JSON.stringify(
    applyModelDefaults(stampConfigVersion(cfg)),
    null,
    2
  ).trimEnd().concat("\n");

  // 5. 写入临时文件 (权限: 0o600)
  const tmp = path.join(dir, `${basename}.${pid}.${uuid}.tmp`);
  await deps.fs.promises.writeFile(tmp, json, {
    encoding: "utf-8",
    mode: 0o600,
  });

  // 6. 备份旧配置
  if (deps.fs.existsSync(configPath)) {
    await rotateConfigBackups(configPath, deps.fs.promises);
    await deps.fs.promises.copyFile(configPath, `${configPath}.bak`);
  }

  // 7. 原子替换 (rename 或 copy + chmod)
  await deps.fs.promises.rename(tmp, configPath);
}
```

### 5.2 配置备份轮转

```typescript
// 备份策略: 保留最近 5 个版本
// moltbot.json.bak     -> 最新备份
// moltbot.json.bak.1   -> 第 2 新
// moltbot.json.bak.2   -> 第 3 新
// moltbot.json.bak.3   -> 第 4 新
// moltbot.json.bak.4   -> 第 5 新 (最旧)

const CONFIG_BACKUP_COUNT = 5;
```

### 5.3 版本戳

```typescript
function stampConfigVersion(cfg: MoltbotConfig): MoltbotConfig {
  const now = new Date().toISOString();
  return {
    ...cfg,
    meta: {
      ...cfg.meta,
      lastTouchedVersion: VERSION,  // 当前 Moltbot 版本
      lastTouchedAt: now,            // ISO 时间戳
    },
  };
}
```

## 6. 环境变量与配置的关系

### 6.1 环境变量替换

**文件：** `src/config/env-substitution.ts`

**语法规则：**
```typescript
// 支持的语法:
// 1. ${VAR_NAME}     - 替换为环境变量值
// 2. $${VAR_NAME}    - 转义,输出字面量 ${VAR_NAME}

// 变量名规则:
const ENV_VAR_NAME_PATTERN = /^[A-Z_][A-Z0-9_]*$/;
// - 必须以大写字母或下划线开头
// - 只能包含大写字母、数字、下划线
```

### 6.2 环境变量注入

**文件：** `src/config/env-vars.ts`

```typescript
export function collectConfigEnvVars(cfg?: MoltbotConfig): Record<string, string> {
  const envConfig = cfg?.env;
  if (!envConfig) return {};

  const entries: Record<string, string> = {};

  // 1. 从 env.vars 收集
  if (envConfig.vars) {
    for (const [key, value] of Object.entries(envConfig.vars)) {
      if (!value) continue;
      entries[key] = value;
    }
  }

  // 2. 从 env 顶级键收集 (排除 shellEnv 和 vars)
  for (const [key, value] of Object.entries(envConfig)) {
    if (key === "shellEnv" || key === "vars") continue;
    if (typeof value !== "string" || !value.trim()) continue;
    entries[key] = value;
  }

  return entries;
}
```

### 6.3 Shell 环境变量回退

```typescript
// 预期的环境变量列表
const SHELL_ENV_EXPECTED_KEYS = [
  "OPENAI_API_KEY",
  "ANTHROPIC_API_KEY",
  "ANTHROPIC_OAUTH_TOKEN",
  "GEMINI_API_KEY",
  "TELEGRAM_BOT_TOKEN",
  "DISCORD_BOT_TOKEN",
  "SLACK_BOT_TOKEN",
  // ... 更多
];

// 在配置加载时,如果启用 shellEnv,会执行:
// $SHELL -l -c 'env -0'
// 从登录 shell 导入缺失的环境变量
```

## 7. 高级特性

### 7.1 配置包含机制

**文件：** `src/config/includes.ts`

**$include 指令语法：**

```json5
// 1. 单文件包含
{
  "$include": "./base.json5"
}

// 2. 多文件合并
{
  "$include": ["./a.json5", "./b.json5"]
}

// 3. 包含 + 覆盖
{
  "$include": "./base.json5",
  "agents": {
    "defaults": {
      "model": {
        "primary": "anthropic/claude-opus-4-5"
      }
    }
  }
}
```

**深度合并策略：**
```typescript
export function deepMerge(target: unknown, source: unknown): unknown {
  // 数组: 连接
  if (Array.isArray(target) && Array.isArray(source)) {
    return [...target, ...source];
  }

  // 对象: 递归合并
  if (isPlainObject(target) && isPlainObject(source)) {
    const result: Record<string, unknown> = { ...target };
    for (const key of Object.keys(source)) {
      result[key] = key in result
        ? deepMerge(result[key], source[key])
        : source[key];
    }
    return result;
  }

  // 原始类型: source 覆盖 target
  return source;
}
```

**安全限制：**
- 循环引用检测
- 最大深度限制 (10 层)

### 7.2 运行时覆盖

**文件：** `src/config/runtime-overrides.ts`

```typescript
// 设置覆盖
export function setConfigOverride(pathRaw: string, value: unknown): {
  ok: boolean;
  error?: string;
}

// 取消覆盖
export function unsetConfigOverride(pathRaw: string): {
  ok: boolean;
  removed: boolean;
  error?: string;
}

// 应用覆盖
export function applyConfigOverrides(cfg: MoltbotConfig): MoltbotConfig

// 重置所有覆盖
export function resetConfigOverrides(): void
```

**使用场景：**
- `/debug` 命令临时修改配置
- 测试环境动态调整配置
- 不持久化的运行时调整

## 8. 关键文件索引

| 文件 | 说明 |
|------|------|
| `io.ts` | 配置 I/O 核心 |
| `paths.ts` | 配置路径解析 |
| `types.clawdbot.ts` | 主类型定义 |
| `zod-schema.ts` | Zod Schema 验证 |
| `validation.ts` | 验证流程 |
| `defaults.ts` | 默认值应用 |
| `env-substitution.ts` | 环境变量替换 |
| `env-vars.ts` | 环境变量注入 |
| `includes.ts` | 配置包含机制 |
| `runtime-overrides.ts` | 运行时覆盖 |
| `normalize-paths.ts` | 路径规范化 |
